<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Avalon Online - Pro</title>
    <style>
        :root { --primary: #e94560; --bg: #1a1a2e; --card: #16213e; --accent: #f1c40f; --blue: #3498db; --red: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; text-align: center; margin: 0; padding-bottom: 50px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; max-width: 500px; margin: 20px auto; border: 1px solid #0f3460; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
        input { width: 90%; padding: 12px; margin: 10px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; }
        .p-item { padding: 10px; border-bottom: 1px solid #333; text-align: left; }
    </style>
</head>
<body>

<div id="setup-screen" class="card">
    <h2>ğŸ° ã‚¢ãƒ´ã‚¡ãƒ­ãƒ³ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</h2>
    <input type="text" id="player-name" placeholder="ã‚ãªãŸã®åå‰">
    <input type="text" id="room-id" placeholder="ãƒ«ãƒ¼ãƒ ã‚­ãƒ¼ï¼ˆä¾‹: take123ï¼‰">
    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:var(--accent); color:#000;" onclick="handleJoin(true)">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
        <button class="btn" onclick="handleJoin(false)">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>
</div>

<div id="lobby-screen" class="card" style="display:none;">
    <h3>ãƒ«ãƒ¼ãƒ : <span id="current-room-display" style="color:var(--accent)"></span></h3>
    <div style="margin-top:20px;">
        <h4>å‚åŠ è€… (<span id="player-count">0</span>)</h4>
        <div id="list-items"></div>
    </div>
    <div id="host-controls" style="display:none;">
        <p style="color:var(--accent); font-size:0.8em;">ã‚ãªãŸã¯ãƒ›ã‚¹ãƒˆã§ã™ã€‚5äººä»¥ä¸Šã§é–‹å§‹ã§ãã¾ã™ã€‚</p>
        <button class="btn" style="background:var(--accent); color:#000;" onclick="setupRoles()">å½¹è·ã‚’é…å¸ƒã—ã¦é–‹å§‹</button>
    </div>
</div>

<div id="game-screen" style="display:none;" class="card">
    <h2 id="my-role-name" style="color:var(--accent)"></h2>
    <p id="status-msg"></p>
    <div id="action-area"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAe0JL5gdcLJ16GTuTd9fU-MHeHaILbpCY",
        authDomain: "avalon-online-51a54.firebaseapp.com",
        databaseURL: "https://avalon-online-51a54-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "avalon-online-51a54",
        appId: "1:557710503935:web:f50ee0e3e2febe328601ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myName = "";
    let currentRoom = "";
    let myId = null;

    window.handleJoin = async function(isHostRequest) {
        myName = document.getElementById('player-name').value;
        currentRoom = document.getElementById('room-id').value;
        if (!myName || !currentRoom) return alert("åå‰ã¨ãƒ«ãƒ¼ãƒ ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã­ï¼");

        const roomRef = ref(db, `rooms/${currentRoom}`);
        const snap = await get(roomRef);
        const roomData = snap.val() || {};

        // 1. ãƒ›ã‚¹ãƒˆè¨­å®šã®åŒæœŸ
        if (isHostRequest) {
            // èª°ã‚‚ã„ãªã„ã‹ã€è‡ªåˆ†ãŒãƒ›ã‚¹ãƒˆã ã£ãŸå ´åˆã®ã¿ãƒ›ã‚¹ãƒˆåã‚’æ›¸ãè¾¼ã‚€
            if (!roomData.hostName || roomData.hostName === myName) {
                await update(roomRef, { hostName: myName });
            } else {
                alert("ã“ã®ãƒ«ãƒ¼ãƒ ã«ã¯æ—¢ã«åˆ¥ã®ãƒ›ã‚¹ãƒˆãŒã„ã¾ã™ã€‚ã€Œãƒ«ãƒ¼ãƒ ã«å‚åŠ ã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚");
                return;
            }
        }

        // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚IDãŒå¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
        const pSnap = await get(ref(db, `rooms/${currentRoom}/players`));
        const players = pSnap.val() || {};
        let foundId = Object.keys(players).find(id => players[id].name === myName);
        
        if (foundId === undefined) {
            foundId = Object.keys(players).length;
            await set(ref(db, `rooms/${currentRoom}/players/${foundId}`), { id: foundId, name: myName });
        }
        myId = foundId;

        // UIåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'block';
        document.getElementById('current-room-display').innerText = currentRoom;

        // 3. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;
            const pList = data.players ? Object.values(data.players) : [];
            
            // å‚åŠ è€…ãƒªã‚¹ãƒˆæ›´æ–°
            document.getElementById('player-count').innerText = pList.length;
            document.getElementById('list-items').innerHTML = pList.map(p => 
                `<div class="p-item">ğŸ‘¤ ${p.name} ${p.name === data.hostName ? 'ğŸ‘‘' : ''}</div>`
            ).join('');

            // ãƒ›ã‚¹ãƒˆæ¨©é™ã®å¾©æ´»ãƒã‚§ãƒƒã‚¯
            if (data.hostName === myName) {
                document.getElementById('host-controls').style.display = pList.length >= 5 ? 'block' : 'none';
            }

            // ã‚²ãƒ¼ãƒ é–‹å§‹åˆ¤å®š
            if (data.status === 'STARTED') {
                document.getElementById('lobby-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                document.getElementById('my-role-name').innerText = data.players[myId].role;
                document.getElementById('status-msg').innerText = "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼(è©³ç´°ãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã“ã‹ã‚‰è¿½åŠ )";
            }
        });
    };

    window.setupRoles = async () => {
        const snap = await get(ref(db, `rooms/${currentRoom}/players`));
        const players = Object.values(snap.val());
        let pool = ["ãƒãƒ¼ãƒªãƒ³", "æš—æ®ºè€…", "å¿ è‡£", "å¿ è‡£", "æ‰‹å…ˆ", "å¿ è‡£", "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«", "ãƒ¢ãƒ«ã‚¬ãƒŠ"].slice(0, players.length).sort(() => Math.random() - 0.5);
        
        const updates = { status: 'STARTED' };
        players.forEach((p, i) => {
            updates[`players/${p.id}/role`] = pool[i];
        });
        update(ref(db, `rooms/${currentRoom}`), updates);
    };

</script>
</body>
</html>
