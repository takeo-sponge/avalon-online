<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Avalon Online - Custom</title>
    <style>
        :root { --primary: #e94560; --bg: #1a1a2e; --card: #16213e; --accent: #f1c40f; --blue: #3498db; --red: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; text-align: center; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; max-width: 500px; margin: 10px auto; border: 1px solid #0f3460; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
        input[type="text"] { width: 90%; padding: 12px; margin: 10px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; }
        .player-list { text-align: left; margin: 15px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
        .config-section { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left; }
        .role-option { display: flex; align-items: center; margin: 8px 0; font-size: 0.9em; }
        .role-option input { margin-right: 10px; transform: scale(1.2); }
        .error-msg { color: var(--red); font-size: 0.8em; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div id="setup-screen" class="card">
    <h2>ğŸ° ã‚¢ãƒ´ã‚¡ãƒ­ãƒ³ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</h2>
    <input type="text" id="player-name" placeholder="ã‚ãªãŸã®åå‰">
    <input type="text" id="room-id" placeholder="ãƒ«ãƒ¼ãƒ å">
    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:var(--accent); color:#000;" onclick="joinGame(true)">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
        <button class="btn" onclick="joinGame(false)">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>
</div>

<div id="lobby-screen" class="card" style="display:none;">
    <h3>ãƒ«ãƒ¼ãƒ : <span id="room-display" style="color:var(--accent)"></span></h3>
    
    <div class="player-list">
        <h4>å‚åŠ è€… (<span id="player-count">0</span>)</h4>
        <ul id="list-items" style="list-style:none; padding:0;"></ul>
    </div>

    <div id="host-panel" style="display:none;" class="config-section">
        <h4 style="margin-top:0; color:var(--accent);">ğŸ‘‘ ãƒ›ã‚¹ãƒˆè¨­å®š</h4>
        
        <label style="font-size:0.9em;">ãƒ—ãƒ¬ã‚¤äººæ•°ã‚’é¸æŠ:</label>
        <select id="play-limit" style="width:100%; padding:8px; margin-bottom:15px; background:#000; color:#fff;">
            <option value="5">5äºº (æ­£ç¾©3 / é‚ªæ‚ª2)</option>
            <option value="6">6äºº (æ­£ç¾©4 / é‚ªæ‚ª2)</option>
            <option value="7">7äºº (æ­£ç¾©4 / é‚ªæ‚ª3)</option>
            <option value="8">8äºº (æ­£ç¾©5 / é‚ªæ‚ª3)</option>
            <option value="9">9äºº (æ­£ç¾©6 / é‚ªæ‚ª3)</option>
            <option value="10">10äºº (æ­£ç¾©6 / é‚ªæ‚ª4)</option>
        </select>

        <label style="font-size:0.9em;">è¿½åŠ å½¹è·ã®é¸æŠ:</label>
        <div class="role-option"><input type="checkbox" checked disabled> ãƒãƒ¼ãƒªãƒ³ (å¿…é ˆ)</div>
        <div class="role-option"><input type="checkbox" id="role-percival"> ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ« (æ­£ç¾©)</div>
        <div class="role-option"><input type="checkbox" checked disabled> æš—æ®ºè€… (å¿…é ˆ)</div>
        <div class="role-option"><input type="checkbox" id="role-morgana"> ãƒ¢ãƒ«ã‚¬ãƒŠ (é‚ªæ‚ª)</div>
        <div class="role-option"><input type="checkbox" id="role-mordred"> ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰ (é‚ªæ‚ª)</div>
        <div class="role-option"><input type="checkbox" id="role-oberon"> ã‚ªãƒ™ãƒ­ãƒ³ (é‚ªæ‚ª)</div>

        <p id="role-error" class="error-msg">âš ï¸ äººæ•°ã¨å½¹è·ã®æ•°ãŒåˆã„ã¾ã›ã‚“ï¼</p>
        <button class="btn" style="background:var(--accent); color:#000;" onclick="setupRoles()">è¨­å®šã‚’ç¢ºå®šã—ã¦é–‹å§‹</button>
    </div>
    
    <div id="guest-msg" style="display:none; font-size:0.8em; color:#888;">ãƒ›ã‚¹ãƒˆãŒè¨­å®šã‚’å®Œäº†ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
    ã€€<div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 15px;">
    ã€€<span style="font-size: 0.7em; color: #666; display: block; margin-bottom: 5px;">åˆ¥ã®åå‰ã§å…¥ã‚Šç›´ã—ãŸã„å ´åˆã¯ï¼š</span>
    ã€€<button class="btn" style="background:transparent; border: 1px solid #444; color:#888; font-size:0.75em; width: auto; padding: 5px 15px;" onclick="leaveGame()">æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦é€€å‡º</button>
ã€€ã€€ã€€</div>
     </div>

<div id="game-screen" style="display:none;" class="card">
    <div id="mission-track" style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
        <div class="round-circle" id="round-1" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">1</div>
        <div class="round-circle" id="round-2" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">2</div>
        <div class="round-circle" id="round-3" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">3</div>
        <div class="round-circle" id="round-4" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">4</div>
        <div class="round-circle" id="round-5" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">5</div>
    </div>
    
    <h3 id="my-role-name" style="color:var(--accent); font-size:2em; margin:10px 0;"></h3>
    <div id="role-purpose" style="font-weight:bold; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;"></div>
    <div id="role-desc" style="background:rgba(0,0,0,0.4); padding:15px; border-radius:8px; text-align:left; font-size:0.9em;"></div>
    
    <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
    <p id="waiting-msg" style="font-size:0.9em; color:var(--accent);"></p>
    <div id="action-area" style="margin-top:15px;"></div>
</div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAe0JL5gdcLJ16GTuTd9fU-MHeHaILbpCY",
        authDomain: "avalon-online-51a54.firebaseapp.com",
        databaseURL: "https://avalon-online-51a54-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "avalon-online-51a54",
        appId: "1:557710503935:web:f50ee0e3e2febe328601ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", roomId = "", myId = null;

    window.onload = () => {
        const savedName = localStorage.getItem('avalon_name');
        const savedRoom = localStorage.getItem('avalon_room');
        if (savedName && savedRoom) {
            document.getElementById('player-name').value = savedName;
            document.getElementById('room-id').value = savedRoom;
        }
    };

    window.leaveGame = () => {
        if(confirm("ä¿å­˜æƒ…å ±ã‚’æ¶ˆã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
            localStorage.clear();
            location.reload();
        }
    };
    
    window.joinGame = async function(isHostRequest) {
        myName = document.getElementById('player-name').value.trim();
        roomId = document.getElementById('room-id').value.trim();
        if (!myName || !roomId) return alert("å…¥åŠ›ã—ã¦ã­ï¼");

        localStorage.setItem('avalon_name', myName);
        localStorage.setItem('avalon_room', roomId);

        const roomRef = ref(db, `rooms/${roomId}`);
        if (isHostRequest) await update(roomRef, { hostName: myName });

        const pSnap = await get(ref(db, `rooms/${roomId}/players`));
        const players = pSnap.val() || {};
        let foundId = Object.keys(players).find(id => players[id].name === myName);
        if (foundId === undefined) {
            foundId = Object.keys(players).length;
            await set(ref(db, `rooms/${roomId}/players/${foundId}`), { id: foundId, name: myName });
        }
        myId = foundId;
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'block';
        document.getElementById('room-display').innerText = roomId;

        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;
            const pList = data.players ? Object.values(data.players) : [];
            document.getElementById('player-count').innerText = pList.length;

            document.getElementById('list-items').innerHTML = pList.map(p => {
                const isLeader = p.id == data.leaderIdx; 
                const isHost = p.name === data.hostName;
                return `<li>${isLeader ? 'ğŸš© ' : 'ğŸ‘¤ '} ${p.name} ${isHost ? 'ğŸ‘‘' : ''}</li>`;
            }).join('');

            if (data.hostName === myName) {
                document.getElementById('host-panel').style.display = 'block';
            } else {
                document.getElementById('guest-msg').style.display = 'block';
            }

            if (data.status === 'STARTED') {
                showGame(data);
                if (myName === data.hostName) handleAutoJudgment(data, pList);
            }
        });
    };

    window.setupRoles = async function() {
        const limit = parseInt(document.getElementById('play-limit').value);
        const snap = await get(ref(db, `rooms/${roomId}/players`));
        const currentPlayers = Object.values(snap.val() || {});
        if (currentPlayers.length !== limit) return alert(`äººæ•°ãŒåˆã„ã¾ã›ã‚“ï¼`);

        const config = { 5: [3, 2], 6: [4, 2], 7: [4, 3], 8: [5, 3], 9: [6, 3], 10: [6, 4] };
        const [gNeed, eNeed] = config[limit];

        let goodRoles = ["ãƒãƒ¼ãƒªãƒ³"];
        if (document.getElementById('role-percival').checked) goodRoles.push("ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«");
        while (goodRoles.length < gNeed) goodRoles.push("æ­£ç¾©ã®å¿ è‡£");

        let evilRoles = ["æš—æ®ºè€…"];
        if (document.getElementById('role-morgana').checked) evilRoles.push("ãƒ¢ãƒ«ã‚¬ãƒŠ");
        if (document.getElementById('role-mordred').checked) evilRoles.push("ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰");
        if (document.getElementById('role-oberon').checked) evilRoles.push("ã‚ªãƒ™ãƒ­ãƒ³");
        while (evilRoles.length < eNeed) evilRoles.push("é‚ªæ‚ªã®æ‰‹å…ˆ");

        let pool = [...goodRoles, ...evilRoles].sort(() => Math.random() - 0.5);
        const updates = { status: 'STARTED', phase: 'PROPOSING', leaderIdx: 0, voteFailCount: 0, missionHistory: [] };
        currentPlayers.forEach((p, i) => {
            updates[`players/${p.id}/role`] = pool[i];
            updates[`players/${p.id}/side`] = ["æš—æ®ºè€…", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰", "æ‰‹å…ˆ", "ã‚ªãƒ™ãƒ­ãƒ³"].some(r => pool[i].includes(r)) ? "Evil" : "Good";
        });
        update(ref(db, `rooms/${roomId}`), updates);
    };

    function showGame(data) {
        if (!data.players || data.leaderIdx === undefined) return;
        const me = data.players[myId];
        const all = Object.values(data.players);
        const isLeader = data.leaderIdx == myId;
        const leaderName = data.players[data.leaderIdx]?.name || "ãƒªãƒ¼ãƒ€ãƒ¼";

        const history = data.missionHistory || [];
        for (let i = 1; i <= 5; i++) {
            const el = document.getElementById(`round-${i}`);
            const res = history[i-1];
            el.style.background = res === true ? "var(--blue)" : (res === false ? "var(--red)" : "transparent");
        }

        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        document.getElementById('my-role-name').innerText = me.role;
        document.getElementById('role-purpose').innerHTML = `ã€${me.side === "Good" ? "æ­£ç¾©" : "é‚ªæ‚ª"}é™£å–¶ã€‘`;

        const actionArea = document.getElementById('action-area');
        const waitingMsg = document.getElementById('waiting-msg');
        const roundNum = history.length + 1;
        const missionSizes = { 5:[2,3,2,3,3], 6:[2,3,4,3,4], 7:[2,3,3,4,4], 8:[3,4,4,5,5], 9:[3,4,4,5,5], 10:[3,4,4,5,5] };
        const required = missionSizes[all.length]?.[history.length] || "?";
        const failCount = data.voteFailCount || 0;

        // ãƒ­ã‚°ã‚¨ãƒªã‚¢
        let resultLog = document.getElementById('result-log');
        if(!resultLog) {
            resultLog = document.createElement('div');
            resultLog.id = 'result-log';
            document.getElementById('game-screen').insertBefore(resultLog, waitingMsg);
        }

        if (data.phase === 'PROPOSING') {
            resultLog.innerHTML = failCount > 0 ? `<p style="color:var(--red)">âš ï¸ å¦æ±ºã•ã‚Œã¾ã—ãŸ (${failCount}/5)</p>` : "";
            const currentSelected = data.currentProposal || [];
            const memberListHtml = all.map(p => {
                const isSelected = currentSelected.includes(String(p.id));
                return `<div><label><input type="checkbox" class="team-check" value="${p.id}" ${isSelected?'checked':''} ${isLeader?'':'disabled'}> ${p.id==data.leaderIdx?'ğŸš©':''} ${p.name}</label></div>`;
            }).join('');

            waitingMsg.innerHTML = `ç¬¬ ${roundNum} ãƒ©ã‚¦ãƒ³ãƒ‰ (å¿…è¦: ${required}å)<br>ãƒªãƒ¼ãƒ€ãƒ¼: ${leaderName}`;
            actionArea.innerHTML = `
                <div style="text-align:left; background:rgba(255,255,255,0.05); padding:10px; border-radius:5px;">${memberListHtml}</div>
                ${isLeader ? `<button class="btn" onclick="sendProposal(${failCount>=4})">${failCount>=4?'å¼·åˆ¶å‡ºç™º':'ææ¡ˆã‚’ç¢ºå®š'}</button>` : `<p>${leaderName}ã‚’é¸è€ƒä¸­...</p>`}
            `;
            if (isLeader) {
                document.querySelectorAll('.team-check').forEach(el => {
                    el.onchange = () => {
                        const sel = Array.from(document.querySelectorAll('.team-check:checked')).map(cb => cb.value);
                        update(ref(db, `rooms/${roomId}`), { currentProposal: sel });
                    };
                });
            }
        } else if (data.phase === 'VOTING') {
            resultLog.innerHTML = "";
            waitingMsg.innerText = "æŠ•ç¥¨ä¸­...";
            if (!data.votes || data.votes[myId] === undefined) {
                actionArea.innerHTML = `<button class="btn" onclick="castVote(true)">æ‰¿èª</button><button class="btn" style="background:var(--red)" onclick="castVote(false)">å´ä¸‹</button>`;
            } else {
                actionArea.innerHTML = "<p>å¾…æ©Ÿä¸­...</p>";
            }
        } else if (data.phase === 'MISSION') {
            resultLog.innerHTML = "";
            const isMember = (data.currentProposal || []).includes(String(myId));
            waitingMsg.innerText = "ãƒŸãƒƒã‚·ãƒ§ãƒ³å®Ÿè¡Œä¸­...";
            if (isMember && (!data.missions || data.missions[myId] === undefined)) {
                actionArea.innerHTML = `<button class="btn" onclick="castMission(true)">æˆåŠŸ</button>${me.side==='Evil'?'<button class="btn" style="background:var(--red)" onclick="castMission(false)">å¤±æ•—</button>':''}`;
            } else {
                actionArea.innerHTML = "<p>é å¾éšŠã®å ±å‘Šã‚’å¾…ã£ã¦ã„ã¾ã™...</p>";
            }
        }
    }

    window.sendProposal = (isForced) => {
        const sel = Array.from(document.querySelectorAll('.team-check:checked')).map(el => el.value);
        if (sel.length == 0) return alert("é¸ã‚“ã§ï¼");
        if (isForced && !confirm("5äººç›®ãªã®ã§å¼·åˆ¶å‡ºç™ºã—ã¾ã™ï¼")) return;
        update(ref(db, `rooms/${roomId}`), { currentProposal: sel, phase: isForced ? 'MISSION' : 'VOTING', votes: null, missions: null });
    };

    window.castVote = (val) => set(ref(db, `rooms/${roomId}/votes/${myId}`), val);
    window.castMission = (val) => set(ref(db, `rooms/${roomId}/missions/${myId}`), val);

    function handleAutoJudgment(data, pList) {
        if (data.phase === 'VOTING') {
            const votes = data.votes || {};
            if (Object.keys(votes).length === pList.length) {
                const approves = Object.values(votes).filter(v => v === true).length;
                setTimeout(() => {
                    if (approves > pList.length / 2) {
                        update(ref(db, `rooms/${roomId}`), { phase: 'MISSION', missions: null, voteFailCount: 0 });
                    } else {
                        update(ref(db, `rooms/${roomId}`), { 
                            phase: 'PROPOSING', 
                            leaderIdx: (data.leaderIdx + 1) % pList.length, 
                            votes: null, 
                            currentProposal: null, 
                            voteFailCount: (data.voteFailCount || 0) + 1 
                        });
                    }
                }, 1000);
            }
        }
        if (data.phase === 'MISSION') {
            const missions = data.missions || {};
            const team = data.currentProposal || [];
            if (Object.keys(missions).length === team.length) {
                const fails = Object.values(missions).filter(v => v === false).length;
                const history = data.missionHistory || [];
                history.push(fails === 0);
                setTimeout(() => {
                    alert(fails === 0 ? "ğŸ‰ æˆåŠŸï¼" : `ğŸ’€ å¤±æ•—... (${fails}ç¥¨)`);
                    update(ref(db, `rooms/${roomId}`), { 
                        phase: 'PROPOSING', 
                        leaderIdx: (data.leaderIdx + 1) % pList.length, 
                        missions: null, 
                        currentProposal: null, 
                        missionHistory: history 
                    });
                }, 1000);
            }
        }
    }
</script>


</body>
</html>
