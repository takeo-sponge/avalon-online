<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Avalon Online - Remote</title>
    <style>
        :root { --primary: #e94560; --bg: #1a1a2e; --card: #16213e; --accent: #f1c40f; --blue: #3498db; --red: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; text-align: center; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; max-width: 450px; margin: auto; border: 1px solid #0f3460; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
        input { width: 90%; padding: 12px; margin: 10px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; }
        .player-list { text-align: left; margin: 20px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
        .status-badge { font-size: 0.8em; padding: 2px 8px; border-radius: 10px; background: var(--accent); color: #000; margin-left: 10px; }
        .role-box { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; font-size: 0.9em; line-height: 1.6; margin-top: 10px; text-align: left; }
    </style>
</head>
<body>

<div id="setup-screen" class="card">
    <h2>ğŸ° ã‚¢ãƒ´ã‚¡ãƒ­ãƒ³ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</h2>
    <input type="text" id="player-name" placeholder="ã‚ãªãŸã®åå‰">
    <input type="text" id="room-id" placeholder="ãƒ«ãƒ¼ãƒ åï¼ˆä¾‹: take123ï¼‰">
    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:var(--accent); color:#000;" onclick="joinGame(true)">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
        <button class="btn" onclick="joinGame(false)">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>
</div>

<div id="lobby-screen" class="card" style="display:none;">
    <h2>ğŸ° å¾…æ©Ÿå®¤</h2>
    <p>ãƒ«ãƒ¼ãƒ : <b id="room-display" style="color:var(--accent)">...</b></p>
    
    <div id="welcome-msg" style="margin-bottom:10px; font-size:0.9em; color:#bbb;"></div>

    <div class="player-list">
        <h4>å‚åŠ è€… (<span id="player-count">0</span> / 10)</h4>
        <ul id="list-items" style="list-style:none; padding:0;"></ul>
    </div>

    <div id="host-controls" style="display:none;">
        <p style="font-size:0.8em; color:var(--accent);">ã‚ãªãŸã¯ãƒ›ã‚¹ãƒˆã§ã™ã€‚5äººä»¥ä¸Šã§é–‹å§‹ã§ãã¾ã™ã€‚</p>
        <button class="btn" style="background:var(--accent); color:#000;" onclick="setupRoles()">å½¹è·ã‚’é…å¸ƒã—ã¦é–‹å§‹</button>
    </div>
</div>

<div id="game-screen" style="display:none;" class="card">
    <h3>ã‚ãªãŸã®å½¹è·</h3>
    <h1 id="my-role-name" style="color:var(--accent);">???</h1>
    <div id="role-purpose" style="font-weight:bold; margin-bottom:10px;"></div>
    <div id="role-desc" class="role-box"></div>
    <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
    <p id="waiting-msg">é å¾ã®ãƒªãƒ¼ãƒ€ãƒ¼ãŒãƒãƒ¼ãƒ ã‚’ææ¡ˆã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAe0JL5gdcLJ16GTuTd9fU-MHeHaILbpCY",
        authDomain: "avalon-online-51a54.firebaseapp.com",
        databaseURL: "https://avalon-online-51a54-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "avalon-online-51a54",
        appId: "1:557710503935:web:f50ee0e3e2febe328601ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myName = "";
    let roomId = "";
    let myId = null;

    // --- å…¥å®¤ãƒ»ä½œæˆå‡¦ç† ---
    window.joinGame = async function(isHostRequest) {
        myName = document.getElementById('player-name').value.trim();
        roomId = document.getElementById('room-id').value.trim();
        
        if (!myName || !roomId) return alert("åå‰ã¨ãƒ«ãƒ¼ãƒ åã‚’å…¥ã‚Œã¦ã­ï¼");

        const roomRef = ref(db, `rooms/${roomId}`);
        const snap = await get(roomRef);
        const roomData = snap.val() || {};

        // ãƒ›ã‚¹ãƒˆæ¨©é™ã®ãƒã‚§ãƒƒã‚¯
        if (isHostRequest) {
            if (roomData.hostName && roomData.hostName !== myName) {
                if(!confirm("ä»–ã®ãƒ›ã‚¹ãƒˆãŒæ—¢ã«ã„ã¾ã™ã€‚ãƒ›ã‚¹ãƒˆã¨ã—ã¦å…¥ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) return;
            }
            await update(roomRef, { hostName: myName });
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã®ç¢ºå®šï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼‰
        const playersRef = ref(db, `rooms/${roomId}/players`);
        const pSnap = await get(playersRef);
        const players = pSnap.val() || {};
        let foundId = Object.keys(players).find(id => players[id].name === myName);
        
        if (foundId === undefined) {
            foundId = Object.keys(players).length;
            await set(ref(db, `rooms/${roomId}/players/${foundId}`), { id: foundId, name: myName, role: "", side: "" });
        }
        myId = foundId;
        sessionStorage.setItem('avalon_myId', myId);

        // UIåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'block';
        document.getElementById('room-display').innerText = roomId;
        document.getElementById('welcome-msg').innerText = `ã‚ˆã†ã“ãã€${myName}ã•ã‚“`;

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸé–‹å§‹
        monitorRoom();
    };

    function monitorRoom() {
        onValue(ref(db, `rooms/${roomId}`), (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const playerArray = data.players ? Object.values(data.players) : [];
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°
            document.getElementById('player-count').innerText = playerArray.length;
            document.getElementById('list-items').innerHTML = playerArray.map(p => 
                `<li>ğŸ‘¤ ${p.name} ${p.name === data.hostName ? '<span class="status-badge">Host</span>' : ''}</li>`
            ).join('');

            // ãƒ›ã‚¹ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤º
            if (data.hostName === myName) {
                document.getElementById('host-controls').style.display = playerArray.length >= 5 ? 'block' : 'none';
            }

            // ã‚²ãƒ¼ãƒ é–‹å§‹æ¤œçŸ¥
            if (data.status === 'ROLE_DISTRIBUTED') {
                showRoleScreen(data);
            }
        });
    }

    // --- å½¹è·é…å¸ƒï¼ˆäººæ•°ã«åˆã‚ã›ã¦è‡ªå‹•èª¿æ•´ï¼‰ ---
    window.setupRoles = async function() {
        const snap = await get(ref(db, `rooms/${roomId}/players`));
        const players = Object.values(snap.val());
        const count = players.length;

        // 5~10äººå¯¾å¿œã®å½¹è·ãƒ—ãƒ¼ãƒ«
        const goodPool = ["ãƒãƒ¼ãƒªãƒ³", "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«", "æ­£ç¾©ã®å¿ è‡£", "æ­£ç¾©ã®å¿ è‡£", "æ­£ç¾©ã®å¿ è‡£", "æ­£ç¾©ã®å¿ è‡£"];
        const evilPool = ["æš—æ®ºè€…", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰", "é‚ªæ‚ªã®æ‰‹å…ˆ", "é‚ªæ‚ªã®æ‰‹å…ˆ"];
        
        let gCount = (count >= 9) ? 6 : (count >= 7) ? 4 : (count === 8) ? 5 : 3;
        let pool = [...goodPool.slice(0, gCount), ...evilPool.slice(0, count - gCount)];
        pool = pool.sort(() => Math.random() - 0.5);

        const updates = {};
        players.forEach((p, i) => {
            const role = pool[i];
            const side = ["æš—æ®ºè€…", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰", "é‚ªæ‚ªã®æ‰‹å…ˆ"].includes(role) ? "Evil" : "Good";
            updates[`players/${p.id}/role`] = role;
            updates[`players/${p.id}/side`] = side;
        });
        updates['status'] = 'ROLE_DISTRIBUTED';
        updates['leaderIdx'] = 0;
        
        update(ref(db, `rooms/${roomId}`), updates);
    };

    function showRoleScreen(data) {
        const me = data.players[myId];
        const allPlayers = Object.values(data.players);

        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        document.getElementById('my-role-name').innerText = me.role;

        let purpose = me.side === "Good" ? "ã€ç›®çš„ã€‘é å¾ã‚’3å›æˆåŠŸã•ã›ã‚ˆï¼" : "ã€ç›®çš„ã€‘é å¾ã‚’3å›å¤±æ•—ã•ã›ã‚‹ã‹æš—æ®ºã›ã‚ˆï¼";
        document.getElementById('role-purpose').innerText = purpose;

        // ç‰¹æ®Šã‚¹ã‚­ãƒ«ã®å¯è¦–åŒ–ãƒ­ã‚¸ãƒƒã‚¯
        let info = "";
        if (me.role === "ãƒãƒ¼ãƒªãƒ³") {
            const evils = allPlayers.filter(p => p.side === "Evil" && p.role !== "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰").map(p => p.name);
            info = `ã€äºˆè¦‹ã—ãŸé‚ªæ‚ªãªè€…ã€‘<br>${evils.join(", ")}<br><small>â€»ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰ã¯æ­£ä½“ãŒè¦‹ãˆã¾ã›ã‚“</small>`;
        } else if (me.role === "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«") {
            const targets = allPlayers.filter(p => p.role === "ãƒãƒ¼ãƒªãƒ³" || p.role === "ãƒ¢ãƒ«ã‚¬ãƒŠ").map(p => p.name);
            info = `ã€ãƒãƒ¼ãƒªãƒ³å€™è£œï¼ˆä¸€æ–¹ã¯ãƒ¢ãƒ«ã‚¬ãƒŠï¼‰ã€‘<br>${targets.join(", ")}`;
        } else if (me.side === "Evil") {
            const friends = allPlayers.filter(p => p.side === "Evil" && p.id != myId).map(p => p.name);
            info = friends.length > 0 ? `ã€é‚ªæ‚ªãªä»²é–“ã€‘<br>${friends.join(", ")}` : "ä»²é–“ã¯ã„ã¾ã›ã‚“ï¼ˆå­¤ç‹¬ãªæˆ¦ã„ã§ã™ï¼‰";
        } else {
            info = "ã‚ãªãŸã¯æ­£ç¾©ã®é™£å–¶ã§ã™ã€‚èª°ãŒå‘³æ–¹ã‹æ…é‡ã«è¦‹æ¥µã‚ã¾ã—ã‚‡ã†ã€‚";
        }
        document.getElementById('role-desc').innerHTML = info;
    }
</script>
</body>
</html>
