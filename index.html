<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Avalon Online - Remote</title>
    <style>
        :root { --primary: #e94560; --bg: #1a1a2e; --card: #16213e; --accent: #f1c40f; --blue: #3498db; --red: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; text-align: center; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; max-width: 450px; margin: auto; border: 1px solid #0f3460; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
        input { width: 90%; padding: 12px; margin: 10px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; }
        .player-list { text-align: left; margin: 20px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
        .status-badge { font-size: 0.8em; padding: 2px 8px; border-radius: 10px; background: var(--accent); color: #000; margin-left: 10px; }
    </style>
</head>
<body>

<div id="lobby-screen" class="card">
    <h2>ğŸ° ã‚¢ãƒ´ã‚¡ãƒ­ãƒ³ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</h2>
    <p>ãƒ«ãƒ¼ãƒ : <b id="room-display">...</b></p>
    
    <div id="join-area">
        <input type="text" id="player-name" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›">
        <button class="btn" onclick="joinGame()">å…¥å®¤ã™ã‚‹</button>
    </div>

    <div class="player-list">
        <h4>å‚åŠ è€… (<span id="player-count">0</span> / 10)</h4>
        <ul id="list-items" style="list-style:none; padding:0;"></ul>
    </div>

    <div id="host-controls" style="display:none;">
        <p style="font-size:0.8em; color:var(--accent);">ã‚ãªãŸã¯ãƒ›ã‚¹ãƒˆã§ã™ã€‚5äººä»¥ä¸Šã§é–‹å§‹ã§ãã¾ã™ã€‚</p>
        <button class="btn" style="background:var(--accent); color:#000;" onclick="setupRoles()">å½¹è·ã‚’é…å¸ƒã—ã¦é–‹å§‹</button>
    </div>
</div>

<div id="game-screen" style="display:none;" class="card">
    <h3>ã‚ãªãŸã®å½¹è·</h3>
    <h1 id="my-role-name" style="color:var(--accent);">???</h1>
    <div id="role-purpose" style="font-weight:bold; margin-bottom:10px;"></div>
    <div id="role-desc" style="background:rgba(0,0,0,0.4); padding:15px; border-radius:8px; font-size:0.9em; line-height:1.6;"></div>
    <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
    <p id="waiting-msg">ãƒ›ã‚¹ãƒˆãŒé å¾ã‚’é–‹å§‹ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, push, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAe0JL5gdcLJ16GTuTd9fU-MHeHaILbpCY",
        authDomain: "avalon-online-51a54.firebaseapp.com",
        databaseURL: "https://avalon-online-51a54-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "avalon-online-51a54",
        appId: "1:557710503935:web:f50ee0e3e2febe328601ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§éƒ¨å±‹ã‚’åˆ†ã‘ã‚‹ (ä¾‹: index.html?room=take123)
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room') || 'default-room';
    document.getElementById('room-display').innerText = roomId;

    let myId = sessionStorage.getItem('avalon_myId') || null;
    let isHost = false;

    // --- å…¥å®¤å‡¦ç† ---
    window.joinGame = async function() {
        const name = document.getElementById('player-name').value;
        if (!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ã­ï¼");

        const playersRef = ref(db, `rooms/${roomId}/players`);
        const snapshot = await get(playersRef);
        const players = snapshot.val() || {};
        
        const newId = Object.keys(players).length;
        const playerObj = { id: newId, name: name, role: "", side: "" };
        
        await set(ref(db, `rooms/${roomId}/players/${newId}`), playerObj);
        myId = newId;
        sessionStorage.setItem('avalon_myId', myId);
        document.getElementById('join-area').innerHTML = `<p>âœ… å…¥å®¤å®Œäº†ï¼š${name}ã•ã‚“</p>`;
    };

    // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ ---
    onValue(ref(db, `rooms/${roomId}/players`), (snapshot) => {
        const players = snapshot.val() || {};
        const playerArray = Object.values(players);
        const list = document.getElementById('list-items');
        
        list.innerHTML = playerArray.map(p => `<li>ğŸ‘¤ ${p.name} ${p.id == 0 ? '<span class="status-badge">Host</span>' : ''}</li>`).join('');
        document.getElementById('player-count').innerText = playerArray.length;

        // è‡ªåˆ†ãŒãƒ›ã‚¹ãƒˆï¼ˆID=0ï¼‰ãªã‚‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        if (myId == 0) {
            isHost = true;
            if (playerArray.length >= 5) {
                document.getElementById('host-controls').style.display = 'block';
            }
        }
    });

    // --- å½¹è·é…å¸ƒï¼ˆãƒ›ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼‰ ---
    window.setupRoles = async function() {
        const snapshot = await get(ref(db, `rooms/${roomId}/players`));
        const players = Object.values(snapshot.val());
        const count = players.length;

        // äººæ•°ã«å¿œã˜ãŸå½¹è·ãƒ—ãƒ¼ãƒ«ä½œæˆï¼ˆç°¡æ˜“ç‰ˆï¼š6äººæƒ³å®šï¼‰
        let roles = ["ãƒãƒ¼ãƒªãƒ³", "æš—æ®ºè€…", "æ­£ç¾©ã®å¿ è‡£", "æ­£ç¾©ã®å¿ è‡£", "é‚ªæ‚ªã®æ‰‹å…ˆ", "æ­£ç¾©ã®å¿ è‡£"];
        roles = roles.slice(0, count).sort(() => Math.random() - 0.5);

        const updates = {};
        players.forEach((p, i) => {
            const role = roles[i];
            const side = ["æš—æ®ºè€…", "é‚ªæ‚ªã®æ‰‹å…ˆ"].includes(role) ? "Evil" : "Good";
            updates[`players/${p.id}/role`] = role;
            updates[`players/${p.id}/side`] = side;
        });
        updates['status'] = 'ROLE_DISTRIBUTED';
        
        update(ref(db, `rooms/${roomId}`), updates);
    };

    // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ç›£è¦– ---
    onValue(ref(db, `rooms/${roomId}/status`), (snapshot) => {
        const status = snapshot.val();
        if (status === 'ROLE_DISTRIBUTED') {
            showRoleScreen();
        }
    });

    async function showRoleScreen() {
        const snapshot = await get(ref(db, `rooms/${roomId}/players/${myId}`));
        const me = snapshot.val();

        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        document.getElementById('my-role-name').innerText = me.role;

        // å½¹è·èª¬æ˜ï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆã‹ã‚‰ç§»æ¤ï¼‰
        let purpose = me.side === "Good" ? "ã€ç›®çš„ã€‘é å¾ã‚’3å›æˆåŠŸã•ã›ã‚ˆï¼" : "ã€ç›®çš„ã€‘é å¾ã‚’3å›å¤±æ•—ã•ã›ã‚‹ã‹æš—æ®ºã›ã‚ˆï¼";
        document.getElementById('role-purpose').innerText = purpose;
        document.getElementById('role-desc').innerText = "â€»ã“ã“ã«ä»²é–“ã®æƒ…å ±ã‚„è©³ç´°ã‚¹ã‚­ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§æ‹¡å¼µã—ã¾ã™ã€‚";
    }
</script>
</body>
</html>
