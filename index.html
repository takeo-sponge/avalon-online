<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Avalon Online - Fully Fixed</title>
    <style>
        :root { --primary: #e94560; --bg: #1a1a2e; --card: #16213e; --accent: #f1c40f; --blue: #3498db; --red: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; text-align: center; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; max-width: 500px; margin: auto; border: 1px solid #0f3460; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
        .btn:disabled { background: #444; }
        input { width: 90%; padding: 12px; margin: 10px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; }
        .p-list { text-align: left; list-style: none; padding: 0; }
        .p-item { padding: 8px; border-bottom: 1px solid #333; }
        .info-tag { font-size: 0.8em; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white; background: var(--red); }
    </style>
</head>
<body>

<div id="lobby-screen" class="card">
    <h2>ğŸ° ãƒ«ãƒ¼ãƒ : <span id="room-display">...</span></h2>
    <div id="join-area">
        <input type="text" id="player-name" placeholder="åå‰ã‚’å…¥åŠ›">
        <button class="btn" onclick="joinGame()">å…¥å®¤ã™ã‚‹</button>
    </div>
    <div style="margin-top:20px; text-align:left;">
        <h4>å‚åŠ è€… (<span id="player-count">0</span>)</h4>
        <ul id="list-items" class="p-list"></ul>
    </div>
    <div id="host-controls" style="display:none;">
        <button class="btn" style="background:var(--accent); color:#000;" onclick="setupRoles()">å½¹è·ã‚’é…å¸ƒã—ã¦é–‹å§‹</button>
    </div>
</div>

<div id="game-screen" style="display:none;" class="card">
    <h3 id="round-info">ç¬¬1é å¾</h3>
    <div style="border: 1px solid var(--accent); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
        <h2 id="my-role-name" style="color:var(--accent); margin:5px 0;">???</h2>
        <div id="my-purpose" style="font-size:0.8em; font-weight:bold; color:var(--accent);"></div>
        <div id="my-skill" style="font-size:0.85em; margin-top:5px; opacity:0.9;"></div>
    </div>
    <div id="main-action-area">
        <p id="status-msg">å¾…æ©Ÿä¸­...</p>
        <div id="proposal-area" style="display:none;">
            <div id="member-select" style="text-align:left; margin-bottom:10px;"></div>
            <button class="btn" onclick="proposeTeam()">ãƒãƒ¼ãƒ ã‚’ææ¡ˆã™ã‚‹</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAe0JL5gdcLJ16GTuTd9fU-MHeHaILbpCY",
        authDomain: "avalon-online-51a54.firebaseapp.com",
        databaseURL: "https://avalon-online-51a54-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "avalon-online-51a54",
        appId: "1:557710503935:web:f50ee0e3e2febe328601ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room') || 'default-room';
    document.getElementById('room-display').innerText = roomId;

    let myId = sessionStorage.getItem('avalon_myId');
    let players = [];

    window.joinGame = async function() {
        const name = document.getElementById('player-name').value;
        if (!name) return;
        const snapshot = await get(ref(db, `rooms/${roomId}/players`));
        myId = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
        sessionStorage.setItem('avalon_myId', myId);
        await set(ref(db, `rooms/${roomId}/players/${myId}`), { id: myId, name: name, role: "" });
        document.getElementById('join-area').innerHTML = `<p>âœ… å…¥å®¤æ¸ˆã¿: ${name}</p>`;
    };

    onValue(ref(db, `rooms/${roomId}`), (snapshot) => {
        const data = snapshot.val() || {};
        players = data.players ? Object.values(data.players) : [];
        
        // ãƒ­ãƒ“ãƒ¼æ›´æ–°
        document.getElementById('player-count').innerText = players.length;
        document.getElementById('list-items').innerHTML = players.map(p => `<li class="p-item">ğŸ‘¤ ${p.name} ${p.id == 0 ? 'ğŸ‘‘' : ''}</li>`).join('');
        
        if (myId == 0 && players.length >= 5 && data.status !== 'STARTED') {
            document.getElementById('host-controls').style.display = 'block';
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹å¾Œã®å‡¦ç†
        if (data.status === 'STARTED') {
            showGameScreen(data);
        }
    });

    window.setupRoles = async function() {
        const count = players.length;
        // 10äººã¾ã§å¯¾å¿œã—ãŸå½¹è·ãƒªã‚¹ãƒˆ
        let pool = [
            "ãƒãƒ¼ãƒªãƒ³", "æš—æ®ºè€…", "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "æ­£ç¾©ã®å¿ è‡£", 
            "é‚ªæ‚ªã®æ‰‹å…ˆ", "æ­£ç¾© de å¿ è‡£", "æ­£ç¾© de å¿ è‡£", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰", "æ­£ç¾© de å¿ è‡£"
        ].slice(0, count).sort(() => Math.random() - 0.5);

        const updates = {};
        players.forEach((p, i) => {
            const role = pool[i];
            const side = ["æš—æ®ºè€…", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "æ‰‹å…ˆ", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰"].some(r => role.includes(r)) ? "Evil" : "Good";
            updates[`players/${p.id}/role`] = role;
            updates[`players/${p.id}/side`] = side;
        });
        updates['status'] = 'STARTED';
        updates['leaderIdx'] = 0;
        updates['round'] = 1;
        
        update(ref(db, `rooms/${roomId}`), updates);
    };

    function showGameScreen(data) {
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        
        const me = data.players[myId];
        document.getElementById('my-role-name').innerText = me.role;
        document.getElementById('my-purpose').innerText = me.side === "Good" ? "ã€ç›®çš„ã€‘é å¾ã‚’3å›æˆåŠŸã•ã›ã‚ˆï¼" : "ã€ç›®çš„ã€‘3å›å¤±æ•—ã•ã›ã‚‹ã‹æš—æ®ºã›ã‚ˆï¼";
        
        // ç‰¹æ®Šã‚¹ã‚­ãƒ«ã®è¡¨ç¤ºï¼ˆä»²é–“ã®åå‰ãªã©ï¼‰
        let skill = "ç‰¹åˆ¥ãªåŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        const allP = Object.values(data.players);
        if (me.role === "ãƒãƒ¼ãƒªãƒ³") {
            const evils = allP.filter(p => p.side === "Evil" && p.role !== "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰").map(p => p.name);
            skill = `ã€é‚ªæ‚ªãªè€…(é™¤ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰)ã€‘: ${evils.join(", ")}`;
        } else if (me.role === "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«") {
            const targets = allP.filter(p => ["ãƒãƒ¼ãƒªãƒ³", "ãƒ¢ãƒ«ã‚¬ãƒŠ"].includes(p.role)).map(p => p.name);
            skill = `ã€ãƒãƒ¼ãƒªãƒ³å€™è£œã€‘: ${targets.join(", ")}`;
        } else if (me.side === "Evil") {
            const evils = allP.filter(p => p.side === "Evil" && p.role !== "ã‚ªãƒ™ãƒ­ãƒ³").map(p => p.name);
            skill = `ã€é‚ªæ‚ªã®ä»²é–“ã€‘: ${evils.join(", ")}`;
        }
        document.getElementById('my-skill').innerText = skill;

        // ãƒªãƒ¼ãƒ€ãƒ¼ã‹ã©ã†ã‹ã®åˆ¤å®š
        const isLeader = data.leaderIdx == myId;
        const leaderName = data.players[data.leaderIdx].name;
        
        if (!data.currentProposal) {
            document.getElementById('status-msg').innerText = `ãƒªãƒ¼ãƒ€ãƒ¼ ${leaderName} ãŒé¸è€ƒä¸­...`;
            if (isLeader) {
                document.getElementById('proposal-area').style.display = 'block';
                document.getElementById('member-select').innerHTML = allP.map(p => `<div><input type="checkbox" class="p-sel" value="${p.id}"> ${p.name}</div>`).join('');
            } else {
                document.getElementById('proposal-area').style.display = 'none';
            }
        }
    }

    window.proposeTeam = () => {
        const selected = Array.from(document.querySelectorAll('.p-sel:checked')).map(el => el.value);
        // ã“ã“ã«äººæ•°ãƒã‚§ãƒƒã‚¯ã‚’å¾Œã§å…¥ã‚Œã‚‹
        update(ref(db, `rooms/${roomId}/currentProposal`), selected);
    };
</script>
</body>
</html>
