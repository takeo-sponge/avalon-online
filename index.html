<!DOCTYPE html>

<html lang="ja">

<head>

    <meta charset="UTF-8">

    <title>Avalon Online - Custom</title>

    <style>

        :root { --primary: #e94560; --bg: #1a1a2e; --card: #16213e; --accent: #f1c40f; --blue: #3498db; --red: #e74c3c; }

        body { font-family: sans-serif; background: var(--bg); color: #eee; text-align: center; padding: 20px; }

        .card { background: var(--card); padding: 20px; border-radius: 12px; max-width: 500px; margin: 10px auto; border: 1px solid #0f3460; }

        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }

        input[type="text"] { width: 90%; padding: 12px; margin: 10px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; }

        .player-list { text-align: left; margin: 15px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }

        .config-section { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left; }

        .role-option { display: flex; align-items: center; margin: 8px 0; font-size: 0.9em; }

        .role-option input { margin-right: 10px; transform: scale(1.2); }

        .error-msg { color: var(--red); font-size: 0.8em; margin-top: 5px; display: none; }

    </style>

</head>

<body>



<div id="setup-screen" class="card">

    <h2>ğŸ° ã‚¢ãƒ´ã‚¡ãƒ­ãƒ³ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</h2>

    <input type="text" id="player-name" placeholder="ã‚ãªãŸã®åå‰">

    <input type="text" id="room-id" placeholder="ãƒ«ãƒ¼ãƒ å">

    <div style="display:flex; gap:10px;">

        <button class="btn" style="background:var(--accent); color:#000;" onclick="joinGame(true)">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>

        <button class="btn" onclick="joinGame(false)">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>

    </div>

</div>



<div id="lobby-screen" class="card" style="display:none;">

    <h3>ãƒ«ãƒ¼ãƒ : <span id="room-display" style="color:var(--accent)"></span></h3>

    

    <div class="player-list">

        <h4>å‚åŠ è€… (<span id="player-count">0</span>)</h4>

        <ul id="list-items" style="list-style:none; padding:0;"></ul>

    </div>



    <div id="host-panel" style="display:none;" class="config-section">

        <h4 style="margin-top:0; color:var(--accent);">ğŸ‘‘ ãƒ›ã‚¹ãƒˆè¨­å®š</h4>

        

        <label style="font-size:0.9em;">ãƒ—ãƒ¬ã‚¤äººæ•°ã‚’é¸æŠ:</label>

        <select id="play-limit" style="width:100%; padding:8px; margin-bottom:15px; background:#000; color:#fff;">

            <option value="5">5äºº (æ­£ç¾©3 / é‚ªæ‚ª2)</option>

            <option value="6">6äºº (æ­£ç¾©4 / é‚ªæ‚ª2)</option>

            <option value="7">7äºº (æ­£ç¾©4 / é‚ªæ‚ª3)</option>

            <option value="8">8äºº (æ­£ç¾©5 / é‚ªæ‚ª3)</option>

            <option value="9">9äºº (æ­£ç¾©6 / é‚ªæ‚ª3)</option>

            <option value="10">10äºº (æ­£ç¾©6 / é‚ªæ‚ª4)</option>

        </select>



        <label style="font-size:0.9em;">è¿½åŠ å½¹è·ã®é¸æŠ:</label>

        <div class="role-option"><input type="checkbox" checked disabled> ãƒãƒ¼ãƒªãƒ³ (å¿…é ˆ)</div>

        <div class="role-option"><input type="checkbox" id="role-percival"> ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ« (æ­£ç¾©)</div>

        <div class="role-option"><input type="checkbox" checked disabled> æš—æ®ºè€… (å¿…é ˆ)</div>

        <div class="role-option"><input type="checkbox" id="role-morgana"> ãƒ¢ãƒ«ã‚¬ãƒŠ (é‚ªæ‚ª)</div>

        <div class="role-option"><input type="checkbox" id="role-mordred"> ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰ (é‚ªæ‚ª)</div>

        <div class="role-option"><input type="checkbox" id="role-oberon"> ã‚ªãƒ™ãƒ­ãƒ³ (é‚ªæ‚ª)</div>



        <p id="role-error" class="error-msg">âš ï¸ äººæ•°ã¨å½¹è·ã®æ•°ãŒåˆã„ã¾ã›ã‚“ï¼</p>

        <button class="btn" style="background:var(--accent); color:#000;" onclick="setupRoles()">è¨­å®šã‚’ç¢ºå®šã—ã¦é–‹å§‹</button>

    </div>

    

    <div id="guest-msg" style="display:none; font-size:0.8em; color:#888;">ãƒ›ã‚¹ãƒˆãŒè¨­å®šã‚’å®Œäº†ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>

    ã€€<div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 15px;">

    ã€€<span style="font-size: 0.7em; color: #666; display: block; margin-bottom: 5px;">åˆ¥ã®åå‰ã§å…¥ã‚Šç›´ã—ãŸã„å ´åˆã¯ï¼š</span>

    ã€€<button class="btn" style="background:transparent; border: 1px solid #444; color:#888; font-size:0.75em; width: auto; padding: 5px 15px;" onclick="leaveGame()">æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦é€€å‡º</button>

ã€€ã€€ã€€</div>

     </div>



<div id="game-screen" style="display:none;" class="card">

    <div id="mission-track" style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">

        <div class="round-circle" id="round-1" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">1</div>

        <div class="round-circle" id="round-2" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">2</div>

        <div class="round-circle" id="round-3" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">3</div>

        <div class="round-circle" id="round-4" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">4</div>

        <div class="round-circle" id="round-5" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">5</div>

    </div>

    

    <h3 id="my-role-name" style="color:var(--accent); font-size:2em; margin:10px 0;"></h3>

    <div id="role-purpose" style="font-weight:bold; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;"></div>
    
    <div id="role-desc" style="background:rgba(0,0,0,0.4); padding:15px; border-radius:8px; text-align:left; font-size:0.9em;"></div>

    <p id="waiting-msg" style="font-size:0.9em; color:var(--accent);"></p>

    <div id="action-area" style="margin-top:15px;"></div>

    <hr style="border:0; border-top:1px solid #444; margin:20px 0;">

    <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
    <div style="text-align: left; font-size: 0.8em; color: var(--accent); margin-bottom: 5px;">ğŸ“œ ã‚²ãƒ¼ãƒ å±¥æ­´</div>
    <div id="result-log" style="text-align: left; max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid #333;">
        <p style="color:#666; font-size:0.9em;">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
    </div>
</div> ```

</div>



<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";



    const firebaseConfig = {

        apiKey: "AIzaSyAe0JL5gdcLJ16GTuTd9fU-MHeHaILbpCY",

        authDomain: "avalon-online-51a54.firebaseapp.com",

        databaseURL: "https://avalon-online-51a54-default-rtdb.asia-southeast1.firebasedatabase.app",

        projectId: "avalon-online-51a54",

        appId: "1:557710503935:web:f50ee0e3e2febe328601ca"

    };



    const app = initializeApp(firebaseConfig);

    const db = getDatabase(app);

    let myName = "", roomId = "", myId = null;





    // FirebaseåˆæœŸåŒ–ãªã©ã®ã™ãä¸‹ã«è¿½åŠ 

window.onload = () => {

    const savedName = localStorage.getItem('avalon_name');

    const savedRoom = localStorage.getItem('avalon_room');

    //const savedIsHost = localStorage.getItem('avalon_isHost') === 'true';



    if (savedName && savedRoom) {

        document.getElementById('player-name').value = savedName;

        document.getElementById('room-id').value = savedRoom;

        // å°‘ã—ã ã‘å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œï¼ˆç¢ºå®Ÿã«Firebaseã®æº–å‚™ã‚’å¾…ã¤ãŸã‚ï¼‰

        /*

        setTimeout(() => {

            window.joinGame(savedIsHost);

        }, 500);

        */

    }

};



window.leaveGame = () => {

    if(confirm("ä¿å­˜æƒ…å ±ã‚’æ¶ˆã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {

        localStorage.clear();

        location.reload();

    }

};

    

    window.joinGame = async function(isHostRequest) {

        myName = document.getElementById('player-name').value.trim();

        roomId = document.getElementById('room-id').value.trim();

        if (!myName || !roomId) return alert("å…¥åŠ›ã—ã¦ã­ï¼");



        localStorage.setItem('avalon_name', myName);

        localStorage.setItem('avalon_room', roomId);

        localStorage.setItem('avalon_isHost', isHostRequest);



        const roomRef = ref(db, `rooms/${roomId}`);

        const snap = await get(roomRef);

        if (isHostRequest) await update(roomRef, { hostName: myName });



        const pSnap = await get(ref(db, `rooms/${roomId}/players`));

        const players = pSnap.val() || {};

        let foundId = Object.keys(players).find(id => players[id].name === myName);

        if (foundId === undefined) {

            foundId = Object.keys(players).length;

            await set(ref(db, `rooms/${roomId}/players/${foundId}`), { id: foundId, name: myName });

        }

        myId = foundId;

        document.getElementById('setup-screen').style.display = 'none';

        document.getElementById('lobby-screen').style.display = 'block';

        document.getElementById('room-display').innerText = roomId;



        onValue(roomRef, (snapshot) => {

            const data = snapshot.val();

            if (!data) return; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„æ™‚ã¯ä½•ã‚‚ã—ãªã„



            const pList = data.players ? Object.values(data.players) : [];

            document.getElementById('player-count').innerText = pList.length;



            // ğŸš© ä¿®æ­£ï¼šãƒ•ãƒ©ãƒƒã‚°ãŒå‡ºã‚‹ã‚ˆã†ã«æ¯”è¼ƒã‚’ == ã«å¤‰æ›´

            document.getElementById('list-items').innerHTML = pList.map(p => {

                const isLeader = p.id == data.leaderIdx; 

                const isHost = p.name === data.hostName;

                return `<li>${isLeader ? 'ğŸš© ' : 'ğŸ‘¤ '} ${p.name} ${isHost ? 'ğŸ‘‘' : ''}</li>`;

            }).join('');



            if (data.hostName === myName) {

                document.getElementById('host-panel').style.display = 'block';

            } else {

                document.getElementById('guest-msg').style.display = 'block';

            }



            if (data.status === 'STARTED') {

                showGame(data);

                if (myName === data.hostName) {

                    handleAutoJudgment(data, pList);

                }

            }

        });

    };



    window.setupRoles = async function() {

        const limit = parseInt(document.getElementById('play-limit').value);

        const snap = await get(ref(db, `rooms/${roomId}/players`));

        

        if (!snap.exists()) {

            alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä¸€äººã‚‚ã„ã¾ã›ã‚“ï¼");

            return;

        }

        

        const currentPlayers = Object.values(snap.val());



        if (currentPlayers.length !== limit) {

            alert(`ã‚¨ãƒ©ãƒ¼ï¼šè¨­å®šã•ã‚ŒãŸäººæ•°(${limit}äºº)ã¨ç¾åœ¨ã®å‚åŠ äººæ•°(${currentPlayers.length}äºº)ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼`);

            return;

        }



        // é™£å–¶ã”ã¨ã®äººæ•°å®šç¾©

        const config = { 5: [3, 2], 6: [4, 2], 7: [4, 3], 8: [5, 3], 9: [6, 3], 10: [6, 4] };

        const [gNeed, eNeed] = config[limit];



        let goodRoles = ["ãƒãƒ¼ãƒªãƒ³"];

        if (document.getElementById('role-percival').checked) goodRoles.push("ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«");

        while (goodRoles.length < gNeed) goodRoles.push("æ­£ç¾©ã®å¿ è‡£");



        let evilRoles = ["æš—æ®ºè€…"];

        if (document.getElementById('role-morgana').checked) evilRoles.push("ãƒ¢ãƒ«ã‚¬ãƒŠ");

        if (document.getElementById('role-mordred').checked) evilRoles.push("ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰");

        if (document.getElementById('role-oberon').checked) evilRoles.push("ã‚ªãƒ™ãƒ­ãƒ³");

        while (evilRoles.length < eNeed) evilRoles.push("é‚ªæ‚ªã®æ‰‹å…ˆ");



        if (goodRoles.length > gNeed || evilRoles.length > eNeed) {

            alert("ã‚¨ãƒ©ãƒ¼ï¼šé¸ã‚“ã å½¹è·ã®æ•°ãŒã€é™£å–¶ã®å®šå“¡ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼");

            return;

        }



        let pool = [...goodRoles, ...evilRoles].sort(() => Math.random() - 0.5);



        // --- ä¿®æ­£å¾Œï¼šãƒªãƒ¼ãƒ€ãƒ¼(leaderIdx)ã‚„ãƒ•ã‚§ãƒ¼ã‚ºã‚’ã—ã£ã‹ã‚Šè¨­å®šã™ã‚‹ ---

        const updates = { 

            status: 'STARTED',

            phase: 'PROPOSING', 

            leaderIdx: 0,        // æœ€åˆã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒªãƒ¼ãƒ€ãƒ¼ã«ã™ã‚‹

            votes: null,         // å¿µã®ãŸã‚åˆæœŸåŒ–

            missions: null       // å¿µã®ãŸã‚åˆæœŸåŒ–

        };

        currentPlayers.forEach((p, i) => {
            const roleName = pool[i];
            updates[`players/${p.id}/role`] = roleName;
            // é‚ªæ‚ªãªå½¹è·ãƒªã‚¹ãƒˆã«åå‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const evilRoles = ["æš—æ®ºè€…", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰", "ã‚ªãƒ™ãƒ­ãƒ³", "é‚ªæ‚ªã®æ‰‹å…ˆ"];
            updates[`players/${p.id}/side`] = evilRoles.includes(roleName) ? "Evil" : "Good";
        });

        update(ref(db, `rooms/${roomId}`), updates);

    };



   function showGame(data) {

        if (!data.players || data.leaderIdx === undefined) return;

        

        const me = data.players[myId];

        const all = Object.values(data.players);

        const isLeader = data.leaderIdx == myId;

        const leaderName = data.players[data.leaderIdx] ? data.players[data.leaderIdx].name : "ãƒªãƒ¼ãƒ€ãƒ¼";



        // ã‚¹ã‚³ã‚¢è¡¨ç¤º

        const history = data.missionHistory || [];

        for (let i = 1; i <= 5; i++) {

            const el = document.getElementById(`round-${i}`);

            const result = history[i - 1];

            el.style.background = result === true ? "var(--blue)" : (result === false ? "var(--red)" : "transparent");

            el.style.borderColor = (result === true || result === false) ? "transparent" : "#444";

        }



        document.getElementById('lobby-screen').style.display = 'none';

        document.getElementById('game-screen').style.display = 'block';

        

        // å½¹è·è¡¨ç¤º

        document.getElementById('my-role-name').innerText = me.role;

        const sideColor = me.side === "Good" ? "#3498db" : "#e74c3c";

        document.getElementById('role-purpose').innerHTML = `

            <span style="color:${sideColor}; font-size:1.2em;">ã€${me.side === "Good" ? "æ­£ç¾©" : "é‚ªæ‚ª"}é™£å–¶ã€‘</span><br>

            <span style="font-size:0.8em; opacity:0.8;">${me.side === "Good" ? "é å¾ã‚’3å›æˆåŠŸã•ã›ã‚ˆï¼" : "é å¾ã‚’3å›å¤±æ•—ã•ã›ã‚‹ã‹ã€ãƒãƒ¼ãƒªãƒ³ã‚’æš—æ®ºã›ã‚ˆï¼"}</span>

        `;



        // ã‚¹ã‚­ãƒ«èª¬æ˜ï¼ˆä¸­èº«ã¯çœç•¥ã›ãšã«ä¿æŒï¼‰

        let info = "";

        if (me.role === "ãƒãƒ¼ãƒªãƒ³") {

            const evils = all.filter(p => p.side === "Evil" && p.role !== "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰").map(p => p.name);

            info = `<b>ğŸ”® äºˆè¦‹ã—ãŸé‚ªæ‚ªãªè€…:</b><br>${evils.join(", ") || "ãªã—"}`;

        } else if (me.role === "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«") {

            const targets = all.filter(p => p.role === "ãƒãƒ¼ãƒªãƒ³" || p.role === "ãƒ¢ãƒ«ã‚¬ãƒŠ").map(p => p.name);

            info = `<b>âœ¨ ãƒãƒ¼ãƒªãƒ³å€™è£œ:</b><br>${targets.join(", ")}`;

        } else if (me.side === "Evil") {

            const friends = all.filter(p => p.side === "Evil" && p.id != myId && p.role !== "ã‚ªãƒ™ãƒ­ãƒ³").map(p => p.name);

            info = `<b>ğŸ˜ˆ é‚ªæ‚ªãªä»²é–“:</b><br>${friends.join(", ") || "ãªã—"}`;

        } else {

            info = "ç‰¹åˆ¥ãªåŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è©±ã—åˆã„ã§é‚ªæ‚ªã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ã€‚";

        }

        document.getElementById('role-desc').innerHTML = info;



        // 3. UIã®å‡ºã—åˆ†ã‘

        const actionArea = document.getElementById('action-area');

        const waitingMsg = document.getElementById('waiting-msg');

        

        // ğŸš© ä¿®æ­£ï¼šå„ãƒ©ã‚¦ãƒ³ãƒ‰ã®å¿…è¦äººæ•°ã‚’è¡¨ç¤º

        const roundNum = history.length + 1;

        const missionSizes = { 5:[2,3,2,3,3], 6:[2,3,4,3,4], 7:[2,3,3,4,4], 8:[3,4,4,5,5], 9:[3,4,4,5,5], 10:[3,4,4,5,5] };

        const required = missionSizes[all.length] ? missionSizes[all.length][history.length] : "?";

        const failCount = data.voteFailCount || 0;

        const resultLog = document.getElementById('result-log');
         if (resultLog && data.lastVoteResult) {
            // æ³¨æ„ï¼šã“ã“ã¯ã€Œæœ€æ–°ã®1ä»¶ã€ã‚’è¡¨ç¤ºã™ã‚‹ä»•çµ„ã¿ã ã‘ã©ã€
            // å±¥æ­´ã‚’ã€Œè“„ç©ã€ã•ã›ã‚‹ã«ã¯Firebaseã«å…¨ãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹ã‹ã€
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å·¥å¤«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã­ã€‚
            // ã²ã¨ã¾ãšã€æœ€æ–°ã®ã€Œèª°ãŒèª°ã‚’ææ¡ˆã—ã¦ã€ã©ã†ãªã£ãŸã‹ã€ã‚’è©³ç´°ã«å‡ºã™ã‚ˆã€‚

             const res = data.lastVoteResult;
             const details = Object.entries(res.details).map(([id, v]) => 
                 `<span style="color:${v ? 'var(--blue)' : 'var(--red)'}">${data.players[id] ? data.players[id].name : id}${v ? 'â—¯' : 'Ã—'}</span>`
             ).join(' ');

             resultLog.innerHTML = `
                 <div style="border-left: 4px solid ${res.approved ? 'var(--blue)' : 'var(--red)'}; padding-left: 10px; margin-bottom: 15px;">
                     <strong style="color:var(--accent)">ç¬¬ ${res.round}R - ${res.turn}å›ç›®ææ¡ˆ</strong><br>
                     <small>ãƒªãƒ¼ãƒ€ãƒ¼: ${res.leader}</small><br>
                     <small>ææ¡ˆãƒ¡ãƒ³ãƒãƒ¼: ${res.team}</small><br>
                     <div style="margin: 5px 0;">${res.approved ? 'âœ… æ‰¿èª' : 'âŒ å¦æ±º'}</div>
                     <div style="font-size: 0.9em; opacity: 0.8;">${details}</div>
                 </div>
             ` + resultLog.innerHTML; // å¤ã„ãƒ­ã‚°ã‚’ä¸‹ã«æ®‹ã™
         } 


       if (!data.phase || data.phase === 'PROPOSING') {

            waitingMsg.innerHTML = `ç¬¬ ${roundNum} ãƒ©ã‚¦ãƒ³ãƒ‰ (å¿…è¦äººæ•°: <b>${required}å</b>)<br>ãƒªãƒ¼ãƒ€ãƒ¼: ${leaderName}`;


            // ğŸš© ãƒªãƒ¼ãƒ€ãƒ¼ãŒèª°ã‚’é¸ã‚“ã§ã„ã‚‹ã‹å…¨å“¡ã«è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

            // data.currentProposal ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹æƒ³å®šï¼ˆå¾Œè¿°ã®ä¿®æ­£ãŒå¿…è¦ï¼‰

            const currentSelected = data.currentProposal || [];

            

            const memberListHtml = all.map(p => {

                const isSelected = currentSelected.includes(String(p.id));

                const isPLeader = p.id == data.leaderIdx;

                return `

                    <div style="margin-bottom:5px;">

                        <label>

                            <input type="checkbox" class="team-check" value="${p.id}" 

                                ${isSelected ? 'checked' : ''} 

                                ${isLeader ? '' : 'disabled'}> 

                            ${isPLeader ? 'ğŸš©' : ''} ${p.name}

                        </label>

                    </div>`;

            }).join('');



            if (isLeader) {

                const isLastChance = failCount >= 4;

                actionArea.innerHTML = `

                    <h4 style="margin:0 0 10px 0;">${isLastChance ? 'ã€æœ€çµ‚ç¢ºèªã€‘' : ''}é å¾ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</h4>

                    <div style="text-align:left; background:rgba(255,255,255,0.05); padding:10px; border-radius:5px;">

                        ${memberListHtml}

                    </div>

                    <button class="btn" onclick="sendProposal(${isLastChance})">

                        ${isLastChance ? 'å¼·åˆ¶é å¾ã‚’é–‹å§‹ã™ã‚‹' : 'ææ¡ˆã‚’ç¢ºå®šã™ã‚‹'}

                    </button>

                `;



                // ğŸš© ãƒªãƒ¼ãƒ€ãƒ¼ãŒãƒã‚§ãƒƒã‚¯ã‚’å¤‰ãˆã‚‹ãŸã³ã«Firebaseã«ä¿å­˜ã™ã‚‹ä»•çµ„ã¿ã‚’è¿½åŠ ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸç”¨ï¼‰

                setTimeout(() => {

                    document.querySelectorAll('.team-check').forEach(el => {

                        el.onchange = () => {

                            const selected = Array.from(document.querySelectorAll('.team-check:checked')).map(cb => cb.value);

                            update(ref(db, `rooms/${roomId}`), { currentProposal: selected });

                        };

                    });

                }, 100);



            } else {

                actionArea.innerHTML = `

                    <p>${leaderName}ãŒãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸è€ƒä¸­...</p>

                    <div style="text-align:left; background:rgba(255,255,255,0.05); padding:10px; border-radius:5px; opacity:0.8;">

                        ${memberListHtml}

                    </div>

                    <p><small>(å¦æ±ºå›æ•°: ${failCount}/5)</small></p>

                `;

            }

        }

        else if (data.phase === 'VOTING') {

            const teamIds = data.currentProposal || [];

            const teamNames = teamIds.map(id => data.players[id].name).join(", ");

            waitingMsg.innerText = "ãƒãƒ¼ãƒ æ‰¿èªæŠ•ç¥¨ä¸­...";

            if (!data.votes || data.votes[myId] === undefined) {

                actionArea.innerHTML = `

                    <p>ææ¡ˆã•ã‚ŒãŸãƒãƒ¼ãƒ : <b style="color:var(--accent)">${teamNames}</b></p>

                    <div style="display:flex; gap:10px;">

                        <button class="btn" style="background:var(--blue)" onclick="castVote(true)">æ‰¿èª</button>

                        <button class="btn" style="background:var(--red)" onclick="castVote(false)">å´ä¸‹</button>

                    </div>

                `;

            } else {

                actionArea.innerHTML = "<p>ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŠ•ç¥¨ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>";

            }

        }

        else if (data.phase === 'MISSION') {

            const teamIds = data.currentProposal || [];

            const teamNames = teamIds.map(id => data.players[id] ? data.players[id].name : "ä¸æ˜").join(", ");

            const isMember = teamIds.includes(String(myId));



            const resultLog = document.getElementById('result-log');
              

          /*  if (data.phase === 'PROPOSING' && data.voteFailCount > 0) {

                resultLog.innerHTML = `<div style="color:var(--red); padding:10px; border:1px solid var(--red); margin-bottom:10px; border-radius:5px;">

                    âš ï¸ ææ¡ˆãŒå¦æ±ºã•ã‚Œã¾ã—ãŸï¼ (ç¾åœ¨ ${data.voteFailCount}/5 å›å´ä¸‹)

                </div>`;

            } else {

                resultLog.innerHTML = "";

            }
            */

            waitingMsg.innerHTML = `<span style="color:var(--accent)">é å¾ä¸­: ${teamNames}</span>`;

            if (isMember) {

                if (!data.missions || data.missions[myId] === undefined) {

                    actionArea.innerHTML = `

                        <div style="border:2px solid var(--accent); padding:10px; border-radius:10px;">

                            <p>ã“ã®é å¾ã‚’...</p>

                            <div style="display:flex; gap:10px;">

                                <button class="btn" style="background:var(--blue)" onclick="castMission(true)">æˆåŠŸã•ã›ã‚‹</button>

                                ${me.side === 'Evil' ? `<button class="btn" style="background:var(--red)" onclick="castMission(false)">å¤±æ•—ã•ã›ã‚‹</button>` : ''}

                            </div>

                        </div>

                    `;

                } else {

                    actionArea.innerHTML = "<p>å ±å‘Šå®Œäº†ã€‚å¾…æ©Ÿä¸­...</p>";

                }

            } else {

                actionArea.innerHTML = "<p>é å¾ãƒ¡ãƒ³ãƒãƒ¼ä»¥å¤–ã®äººã¯è­°è«–ã—ã¦å¾…ã£ã¦ã­ï¼</p>";

            }

        }

       // ğŸ‘ˆ ã“ã“ã«æ–°ã—ãè¿½åŠ ï¼
        else if (data.phase === 'ASSASSINATION') {
            const assassin = all.find(p => p.role === 'æš—æ®ºè€…');
            waitingMsg.innerHTML = `<span style="color:var(--red)">ğŸ¹ æš—æ®ºãƒ•ã‚§ãƒ¼ã‚º: æš—æ®ºè€…ãŒãƒãƒ¼ãƒªãƒ³ã‚’ç‹™ã£ã¦ã„ã¾ã™...</span>`;

            if (me.role === 'æš—æ®ºè€…') {
                const targets = all.filter(p => p.id != myId);
                const targetButtons = targets.map(p => 
                    `<button class="btn" style="background:#444; margin-bottom:5px;" onclick="executeAssassination(${p.id})">${p.name}ã‚’æš—æ®º</button>`
                ).join('');

                actionArea.innerHTML = `
                    <div style="border:2px solid var(--red); padding:15px; border-radius:10px;">
                        <p style="margin-top:0;">ãƒãƒ¼ãƒªãƒ³ã¯èª°ã ï¼Ÿæ­£è§£ã™ã‚Œã°é€†è»¢å‹åˆ©ï¼</p>
                        ${targetButtons}
                    </div>
                `;
            } else {
                actionArea.innerHTML = `<p>æš—æ®ºè€…ï¼ˆ${assassin ? assassin.name : 'ï¼Ÿ'}ï¼‰ã®æ±ºæ–­ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>`;
            }
       // }

       // showGameé–¢æ•°ã®æœ€å¾Œã€ASSASSINATIONã® else if ãƒ–ãƒ­ãƒƒã‚¯ã®å¾Œã«è¿½åŠ 
        if (data.status === 'FINISHED') {
            const winnerText = data.winner === 'Good' ? 'âœ¨ æ­£ç¾©é™£å–¶ã®å‹åˆ©ï¼ âœ¨' : 'ğŸ’€ é‚ªæ‚ªé™£å–¶ã®å‹åˆ©ï¼ ğŸ’€';
            const winnerColor = data.winner === 'Good' ? 'var(--blue)' : 'var(--red)';
            
            const resultList = all.map(p => 
                `<li style="margin-bottom:8px; list-style:none;">
                    <span style="font-weight:bold; color:${p.side === 'Good' ? 'var(--blue)' : 'var(--red)'}">${p.name}</span>: 
                    <span style="color:var(--accent)">${p.role}</span>
                </li>`
            ).join('');

            actionArea.innerHTML = `
                <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; border: 2px solid ${winnerColor}; margin-top: 20px;">
                    <h2 style="color:${winnerColor}; margin-top:0;">${winnerText}</h2>
                    <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
                    <h4 style="margin-bottom:10px;">ğŸ›¡ï¸ å½¹è·å…¬é–‹ ğŸ›¡ï¸</h4>
                    <ul style="padding:0; text-align:center;">${resultList}</ul>
                    <button class="btn" style="margin-top:20px; background:#444;" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
                </div>
            `;
            waitingMsg.innerHTML = "ã‚²ãƒ¼ãƒ çµ‚äº†";
        }

    }



    // ğŸš© ä¿®æ­£ï¼šææ¡ˆæ™‚ã«5äººç›®ã‹ã©ã†ã‹ã‚’åˆ¤æ–­

    window.sendProposal = (isForced) => {

        const selected = Array.from(document.querySelectorAll('.team-check:checked')).map(el => el.value);

        if (selected.length == 0) return alert("é å¾ã«è¡Œãäººã‚’é¸ã‚“ã§ï¼");

        

        if (isForced) {

            if (!confirm("5äººç›®ã®ãƒªãƒ¼ãƒ€ãƒ¼ãªã®ã§æŠ•ç¥¨ãªã—ã§å¼·åˆ¶å‡ºç™ºã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

            update(ref(db, `rooms/${roomId}`), {

                currentProposal: selected,

                phase: 'MISSION', // ç›´æ¥ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¸

                missions: null,

                voteFailCount: 0  // ãƒªã‚»ãƒƒãƒˆ

            });

        } else {

            update(ref(db, `rooms/${roomId}`), {

                currentProposal: selected,

                phase: 'VOTING',

                votes: null

            });

        }

       
    };

    // --- ã“ã“ã‹ã‚‰ä¸‹ã¯æ–°ã—ã„é–¢æ•°ã¨ã—ã¦è¿½åŠ  ---


    window.castVote = (val) => {

        set(ref(db, `rooms/${roomId}/votes/${myId}`), val);

    };

    // ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®æˆåŠŸãƒ»å¤±æ•—ã‚’é€ä¿¡ã™ã‚‹

    window.castMission = (val) => {

        set(ref(db, `rooms/${roomId}/missions/${myId}`), val);

    };

        // ğŸš© scriptã‚¿ã‚°ã®æœ€å¾Œã®æ–¹ã€window.castMission ã®ä¸‹ã‚ãŸã‚Šã«è¿½åŠ 
    window.executeAssassination = async (targetId) => {
        const snap = await get(ref(db, `rooms/${roomId}`));
        const data = snap.val();
        const targetPlayer = data.players[targetId];
        
        if (!confirm(`${targetPlayer.name} ã‚’æš—æ®ºã—ã¾ã™ã‹ï¼Ÿ`)) return;
    
        const isMerlin = targetPlayer.role === 'ãƒãƒ¼ãƒªãƒ³';
        const finalWinner = isMerlin ? 'Evil' : 'Good';
    
        // ğŸš© ã“ã“ãŒé‡è¦ï¼šã¾ãšFirebaseã‚’æ›´æ–°ã—ã¦ã€å…¨å“¡ã®çŠ¶æ…‹ã‚’ã€ŒFINISHEDã€ã«ã™ã‚‹
        await update(ref(db, `rooms/${roomId}`), {
            status: 'FINISHED',
            winner: finalWinner,
            phase: 'FINISHED',
            assassinationResult: {
                targetName: targetPlayer.name,
                isMerlin: isMerlin
            }
        });

        // ã‚¢ãƒ©ãƒ¼ãƒˆã¯æœ€å¾Œã«å‡ºã™ï¼ˆOKã‚’æŠ¼ã—ãŸç¬é–“ã«ç”»é¢ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ã‚ˆã†ã«ï¼‰
        alert(isMerlin ? `ğŸ¯ æ­£è§£ï¼ãƒãƒ¼ãƒªãƒ³ï¼ˆ${targetPlayer.name}ï¼‰ã‚’æš—æ®ºæˆåŠŸï¼` : `âŒ æ®‹å¿µï¼${targetPlayer.name} ã¯ãƒãƒ¼ãƒªãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
    };
    


    // ãƒ›ã‚¹ãƒˆç”¨ï¼šè‡ªå‹•ã§ãƒ•ã‚§ãƒ¼ã‚ºã‚’é€²ã‚ã‚‹ã‚¸ãƒ£ãƒƒã‚¸é–¢æ•°

    function handleAutoJudgment(data, pList) {

    if (data.phase === 'VOTING') {

        const votes = data.votes || {};

        if (Object.keys(votes).length === pList.length) {

            const approves = Object.values(votes).filter(v => v === true).length;

            const isApproved = approves > pList.length / 2;

            // æŠ•ç¥¨çµæœã®ãƒ­ã‚°ã‚’ä½œæˆ
           const voteLog = {
                round: data.missionHistory ? data.missionHistory.length + 1 : 1,
                turn: (data.voteFailCount || 0) + 1,
                leader: data.players[data.leaderIdx].name,
                team: data.currentProposal.map(id => data.players[id].name).join(", "),
                approved: isApproved,
                details: votes
            };

            setTimeout(() => {
                if (isApproved) {
                    update(ref(db, `rooms/${roomId}`), { 
                        phase: 'MISSION', 
                        missions: null,
                        voteFailCount: 0,
                        lastVoteResult: voteLog // ãƒ­ã‚°ã‚’ä¿å­˜
                    });
                } else {
                    update(ref(db, `rooms/${roomId}`), {
                        phase: 'PROPOSING',
                        leaderIdx: (data.leaderIdx + 1) % pList.length,
                        votes: null,
                        currentProposal: null,
                        voteFailCount: (data.voteFailCount || 0) + 1,
                        lastVoteResult: voteLog // ãƒ­ã‚°ã‚’ä¿å­˜
                    });
                }
            }, 1000);

          /*  setTimeout(() => {

                if (isApproved) {

                    // æ‰¿èªï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚§ãƒ¼ã‚ºã¸

                    update(ref(db, `rooms/${roomId}`), { 

                        phase: 'MISSION', 

                        missions: null,

                        voteFailCount: 0 // é å¾ãŒæ±ºã¾ã£ãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ

                    });

                } else {

                    // å¦æ±ºï¼šã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã—ã¦æ¬¡ã®ãƒªãƒ¼ãƒ€ãƒ¼ã¸

                    const nextFailCount = (data.voteFailCount || 0) + 1;

                    

                    // ã“ã“ã§Firebaseã‚’æ›´æ–°ï¼ã“ã‚Œã§å…¨å“¡ã®ç”»é¢ãŒå¤‰ã‚ã‚‹

                    update(ref(db, `rooms/${roomId}`), {

                        phase: 'PROPOSING',

                        leaderIdx: (data.leaderIdx + 1) % pList.length,

                        votes: null,

                        currentProposal: null,

                        voteFailCount: nextFailCount // ğŸ”¥ ã“ã“ã§ã‚«ã‚¦ãƒ³ãƒˆã‚’ä¿å­˜ï¼

                    });

                    

                    // ãƒ›ã‚¹ãƒˆã ã‘ã‚¢ãƒ©ãƒ¼ãƒˆå‡ºã™ã¨ã‚ºãƒ¬ã‚‹ã®ã§ã€

                    // å…¨å“¡å…±é€šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã™ã‚‹ãªã‚‰ showGame å†…ã§å‡ºã™ã®ãŒã„ã„ã‘ã©ã€

                    // ã¾ãšã¯ã“ã‚Œã§ãƒ‡ãƒ¼ã‚¿ãŒå…¨å“¡ã«é£›ã¶ã‚ˆã†ã«ãªã‚‹ã‚ˆã€‚

                }

            }, 1000);
            */

        }

    }


        // 2. ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®é›†è¨ˆï¼ˆé å¾ãƒ¡ãƒ³ãƒãƒ¼ã®å ±å‘ŠãŒæƒã£ãŸã‚‰ï¼‰

        if (data.phase === 'MISSION') {

            const missions = data.missions || {};

            const memberCount = (data.currentProposal || []).length;

            if (Object.keys(missions).length === memberCount) {

                const fails = Object.values(missions).filter(v => v === false).length;

                const success = fails === 0; // 1æšã§ã‚‚å¤±æ•—ãŒã‚ã‚Œã°å¤±æ•—



                setTimeout(() => {

                    alert(success ? "ğŸ‰ é å¾æˆåŠŸï¼ï¼" : `ğŸ’€ é å¾å¤±æ•—... (å¤±æ•—æ•°: ${fails})`);

                    

                    // 1. ã¾ãšå±¥æ­´ã«ä»Šå›ã®çµæœã‚’è¿½åŠ ã™ã‚‹ï¼

                    const currentHistory = data.missionHistory || [];

                    currentHistory.push(success);



                    // 2. è¿½åŠ ã—ãŸã€Œå¾Œã€ã®ãƒªã‚¹ãƒˆã§ã€å‹åˆ©æ•°ã‚’æ•°ãˆã‚‹

                    const wins = currentHistory.filter(v => v === true).length;

                    const losses = currentHistory.filter(v => v === false).length;
                    

                    // wins ã¨ losses ã‚’æ•°ãˆãŸå¾Œã®å‡¦ç†ã‚’ã“ã‚Œ1ã¤ã«ã¾ã¨ã‚ã‚‹
                    if (wins === 3 || losses === 3) {
                        if (wins === 3) {
                            // æ­£ç¾©ãŒ3å‹ã—ãŸå ´åˆã¯ã€ã¾ã çµ‚ã‚ã‚‰ãšã«ã€Œæš—æ®ºãƒ•ã‚§ãƒ¼ã‚ºã€ã¸
                            alert("æ­£ç¾©é™£å–¶ãŒ3ä»»å‹™æˆåŠŸï¼...ã—ã‹ã—ã€æš—æ®ºè€…ã®ã‚¿ãƒ¼ãƒ³ãŒå§‹ã¾ã‚Šã¾ã™ã€‚");
                            update(ref(db, `rooms/${roomId}`), {
                                phase: 'ASSASSINATION',
                                missionHistory: currentHistory
                            });
                        } else {
                            // é‚ªæ‚ªãŒ3æ•—ã•ã›ãŸå ´åˆã¯ã€ãã®æ™‚ç‚¹ã§é‚ªæ‚ªã®å‹åˆ©ç¢ºå®š
                            alert("é‚ªæ‚ªé™£å–¶ã®å‹åˆ©ï¼ï¼");
                            update(ref(db, `rooms/${roomId}`), {
                                status: 'FINISHED',
                                winner: 'Evil',
                                phase: 'FINISHED',
                                missionHistory: currentHistory
                            });
                        }
                    } else {
                        // ç¶šè¡Œã®å ´åˆ
                        update(ref(db, `rooms/${roomId}`), {
                            phase: 'PROPOSING',
                            leaderIdx: (data.leaderIdx + 1) % pList.length,
                            missions: null,
                            votes: null,
                            currentProposal: null,
                            missionHistory: currentHistory
                        });
                    }

                }, 1500);

            }

        }

    }

    function createLogArea() {
    const area = document.createElement('div');
    area.id = 'result-log';
    const parent = document.getElementById('game-screen');
    parent.insertBefore(area, document.getElementById('waiting-msg'));
    return area;
}

</script>

</body>

</html>
