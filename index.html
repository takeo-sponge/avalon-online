<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Avalon Online - Custom</title>
    <style>
        :root { --primary: #e94560; --bg: #1a1a2e; --card: #16213e; --accent: #f1c40f; --blue: #3498db; --red: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; text-align: center; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; max-width: 500px; margin: 10px auto; border: 1px solid #0f3460; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
        input[type="text"] { width: 90%; padding: 12px; margin: 10px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; }
        .player-list { text-align: left; margin: 15px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
        .config-section { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left; }
        .role-option { display: flex; align-items: center; margin: 8px 0; font-size: 0.9em; }
        .role-option input { margin-right: 10px; transform: scale(1.2); }
        .error-msg { color: var(--red); font-size: 0.8em; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div id="setup-screen" class="card">
    <h2>ğŸ° ã‚¢ãƒ´ã‚¡ãƒ­ãƒ³ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</h2>
    <input type="text" id="player-name" placeholder="ã‚ãªãŸã®åå‰">
    <input type="text" id="room-id" placeholder="ãƒ«ãƒ¼ãƒ å">
    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:var(--accent); color:#000;" onclick="joinGame(true)">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
        <button class="btn" onclick="joinGame(false)">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>
</div>

<div id="lobby-screen" class="card" style="display:none;">
    <h3>ãƒ«ãƒ¼ãƒ : <span id="room-display" style="color:var(--accent)"></span></h3>
    
    <div class="player-list">
        <h4>å‚åŠ è€… (<span id="player-count">0</span>)</h4>
        <ul id="list-items" style="list-style:none; padding:0;"></ul>
    </div>

    <div id="host-panel" style="display:none;" class="config-section">
        <h4 style="margin-top:0; color:var(--accent);">ğŸ‘‘ ãƒ›ã‚¹ãƒˆè¨­å®š</h4>
        
        <label style="font-size:0.9em;">ãƒ—ãƒ¬ã‚¤äººæ•°ã‚’é¸æŠ:</label>
        <select id="play-limit" style="width:100%; padding:8px; margin-bottom:15px; background:#000; color:#fff;">
            <option value="5">5äºº (æ­£ç¾©3 / é‚ªæ‚ª2)</option>
            <option value="6">6äºº (æ­£ç¾©4 / é‚ªæ‚ª2)</option>
            <option value="7">7äºº (æ­£ç¾©4 / é‚ªæ‚ª3)</option>
            <option value="8">8äºº (æ­£ç¾©5 / é‚ªæ‚ª3)</option>
            <option value="9">9äºº (æ­£ç¾©6 / é‚ªæ‚ª3)</option>
            <option value="10">10äºº (æ­£ç¾©6 / é‚ªæ‚ª4)</option>
        </select>

        <label style="font-size:0.9em;">è¿½åŠ å½¹è·ã®é¸æŠ:</label>
        <div class="role-option"><input type="checkbox" checked disabled> ãƒãƒ¼ãƒªãƒ³ (å¿…é ˆ)</div>
        <div class="role-option"><input type="checkbox" id="role-percival"> ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ« (æ­£ç¾©)</div>
        <div class="role-option"><input type="checkbox" checked disabled> æš—æ®ºè€… (å¿…é ˆ)</div>
        <div class="role-option"><input type="checkbox" id="role-morgana"> ãƒ¢ãƒ«ã‚¬ãƒŠ (é‚ªæ‚ª)</div>
        <div class="role-option"><input type="checkbox" id="role-mordred"> ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰ (é‚ªæ‚ª)</div>
        <div class="role-option"><input type="checkbox" id="role-oberon"> ã‚ªãƒ™ãƒ­ãƒ³ (é‚ªæ‚ª)</div>

        <p id="role-error" class="error-msg">âš ï¸ äººæ•°ã¨å½¹è·ã®æ•°ãŒåˆã„ã¾ã›ã‚“ï¼</p>
        <button class="btn" style="background:var(--accent); color:#000;" onclick="setupRoles()">è¨­å®šã‚’ç¢ºå®šã—ã¦é–‹å§‹</button>
    </div>
    
    <div id="guest-msg" style="display:none; font-size:0.8em; color:#888;">ãƒ›ã‚¹ãƒˆãŒè¨­å®šã‚’å®Œäº†ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
    ã€€<div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 15px;">
    ã€€<span style="font-size: 0.7em; color: #666; display: block; margin-bottom: 5px;">åˆ¥ã®åå‰ã§å…¥ã‚Šç›´ã—ãŸã„å ´åˆã¯ï¼š</span>
    ã€€<button class="btn" style="background:transparent; border: 1px solid #444; color:#888; font-size:0.75em; width: auto; padding: 5px 15px;" onclick="leaveGame()">æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦é€€å‡º</button>
ã€€ã€€ã€€</div>
     </div>

<div id="game-screen" style="display:none;" class="card">
    <h3 id="my-role-name" style="color:var(--accent); font-size:2em; margin:10px 0;"></h3>
    <div id="role-purpose" style="font-weight:bold; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;"></div>
    <div id="role-desc" style="background:rgba(0,0,0,0.4); padding:15px; border-radius:8px; text-align:left; font-size:0.9em;"></div>
    
    <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
    <p id="waiting-msg" style="font-size:0.9em; color:var(--accent);"></p>
    <div id="action-area" style="margin-top:15px;"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAe0JL5gdcLJ16GTuTd9fU-MHeHaILbpCY",
        authDomain: "avalon-online-51a54.firebaseapp.com",
        databaseURL: "https://avalon-online-51a54-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "avalon-online-51a54",
        appId: "1:557710503935:web:f50ee0e3e2febe328601ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", roomId = "", myId = null;


    // FirebaseåˆæœŸåŒ–ãªã©ã®ã™ãä¸‹ã«è¿½åŠ 
window.onload = () => {
    const savedName = localStorage.getItem('avalon_name');
    const savedRoom = localStorage.getItem('avalon_room');
    //const savedIsHost = localStorage.getItem('avalon_isHost') === 'true';

    if (savedName && savedRoom) {
        document.getElementById('player-name').value = savedName;
        document.getElementById('room-id').value = savedRoom;
        // å°‘ã—ã ã‘å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œï¼ˆç¢ºå®Ÿã«Firebaseã®æº–å‚™ã‚’å¾…ã¤ãŸã‚ï¼‰
        /*
        setTimeout(() => {
            window.joinGame(savedIsHost);
        }, 500);
        */
    }
};

window.leaveGame = () => {
    if(confirm("ä¿å­˜æƒ…å ±ã‚’æ¶ˆã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
        localStorage.clear();
        location.reload();
    }
};
    
    window.joinGame = async function(isHostRequest) {
        myName = document.getElementById('player-name').value.trim();
        roomId = document.getElementById('room-id').value.trim();
        if (!myName || !roomId) return alert("å…¥åŠ›ã—ã¦ã­ï¼");

        localStorage.setItem('avalon_name', myName);
        localStorage.setItem('avalon_room', roomId);
        localStorage.setItem('avalon_isHost', isHostRequest);

        const roomRef = ref(db, `rooms/${roomId}`);
        const snap = await get(roomRef);
        if (isHostRequest) await update(roomRef, { hostName: myName });

        const pSnap = await get(ref(db, `rooms/${roomId}/players`));
        const players = pSnap.val() || {};
        let foundId = Object.keys(players).find(id => players[id].name === myName);
        if (foundId === undefined) {
            foundId = Object.keys(players).length;
            await set(ref(db, `rooms/${roomId}/players/${foundId}`), { id: foundId, name: myName });
        }
        myId = foundId;
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'block';
        document.getElementById('room-display').innerText = roomId;

        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            const pList = data.players ? Object.values(data.players) : [];
            document.getElementById('player-count').innerText = pList.length;
            document.getElementById('list-items').innerHTML = pList.map(p => `<li>ğŸ‘¤ ${p.name} ${p.name === data.hostName ? 'ğŸ‘‘' : ''}</li>`).join('');
            
            if (data.hostName === myName) {
                document.getElementById('host-panel').style.display = 'block';
            } else {
                document.getElementById('guest-msg').style.display = 'block';
            }

            if (data.status === 'STARTED') showGame(data);
        });
    };

    window.setupRoles = async function() {
        const limit = parseInt(document.getElementById('play-limit').value);
        const snap = await get(ref(db, `rooms/${roomId}/players`));
        const currentPlayers = Object.values(snap.val());

        if (currentPlayers.length !== limit) {
            alert(`ã‚¨ãƒ©ãƒ¼ï¼šè¨­å®šã•ã‚ŒãŸäººæ•°(${limit}äºº)ã¨ç¾åœ¨ã®å‚åŠ äººæ•°(${currentPlayers.length}äºº)ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼`);
            return;
        }

        // é™£å–¶ã”ã¨ã®äººæ•°å®šç¾©
        const config = { 5: [3, 2], 6: [4, 2], 7: [4, 3], 8: [5, 3], 9: [6, 3], 10: [6, 4] };
        const [gNeed, eNeed] = config[limit];

        let goodRoles = ["ãƒãƒ¼ãƒªãƒ³"];
        if (document.getElementById('role-percival').checked) goodRoles.push("ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«");
        while (goodRoles.length < gNeed) goodRoles.push("æ­£ç¾©ã®å¿ è‡£");

        let evilRoles = ["æš—æ®ºè€…"];
        if (document.getElementById('role-morgana').checked) evilRoles.push("ãƒ¢ãƒ«ã‚¬ãƒŠ");
        if (document.getElementById('role-mordred').checked) evilRoles.push("ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰");
        if (document.getElementById('role-oberon').checked) evilRoles.push("ã‚ªãƒ™ãƒ­ãƒ³");
        while (evilRoles.length < eNeed) evilRoles.push("é‚ªæ‚ªã®æ‰‹å…ˆ");

        if (goodRoles.length > gNeed || evilRoles.length > eNeed) {
            alert("ã‚¨ãƒ©ãƒ¼ï¼šé¸ã‚“ã å½¹è·ã®æ•°ãŒã€é™£å–¶ã®å®šå“¡ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼");
            return;
        }

        let pool = [...goodRoles, ...evilRoles].sort(() => Math.random() - 0.5);
        const updates = { status: 'STARTED' };
        currentPlayers.forEach((p, i) => {
            updates[`players/${p.id}/role`] = pool[i];
            updates[`players/${p.id}/side`] = ["æš—æ®ºè€…", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰", "æ‰‹å…ˆ", "ã‚ªãƒ™ãƒ­ãƒ³"].some(r => pool[i].includes(r)) ? "Evil" : "Good";
        });
        update(ref(db, `rooms/${roomId}`), updates);
    };

   function showGame(data) {
       if (!data.players || data.leaderIdx === undefined || !data.players[data.leaderIdx]) {
            console.log("ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒã¾ã æƒã£ã¦ã„ã¾ã›ã‚“...");
            return; 
        }
        const me = data.players[myId];
        const all = Object.values(data.players);
        const isLeader = data.leaderIdx == myId;
        const leaderName = data.players[data.leaderIdx].name;

        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        
        // 1. å½¹è·ã¨é™£å–¶ã®è¡¨ç¤ºï¼ˆãŸã‘ã®è¦æœ›é€šã‚Šã€Œæ­£ç¾©ãƒ»é‚ªæ‚ªã€ã‚’ãƒãƒƒã‚­ãƒªï¼ï¼‰
        document.getElementById('my-role-name').innerText = me.role;
        
        const sideText = me.side === "Good" ? "ã€æ­£ç¾©é™£å–¶ã€‘" : "ã€é‚ªæ‚ªé™£å–¶ã€‘";
        const sideColor = me.side === "Good" ? "#3498db" : "#e74c3c"; // é’ or èµ¤
        const purposeText = me.side === "Good" ? "é å¾ã‚’3å›æˆåŠŸã•ã›ã‚ˆï¼" : "é å¾ã‚’3å›å¤±æ•—ã•ã›ã‚‹ã‹ã€æœ€å¾Œã«ãƒãƒ¼ãƒªãƒ³ã‚’æš—æ®ºã›ã‚ˆï¼";
        
        document.getElementById('role-purpose').innerHTML = `
            <span style="color:${sideColor}; font-size:1.2em;">${sideText}</span><br>
            <span style="font-size:0.8em; opacity:0.8;">${purposeText}</span>
        `;

        // 2. ã‚¹ã‚­ãƒ«èª¬æ˜ã®è¡¨ç¤ºï¼ˆæƒ…å ±ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ï¼ï¼‰
        let info = "";
        if (me.role === "ãƒãƒ¼ãƒªãƒ³") {
            const evils = all.filter(p => p.side === "Evil" && p.role !== "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰").map(p => p.name);
            info = `<b>ğŸ”® äºˆè¦‹ã—ãŸé‚ªæ‚ªãªè€…:</b><br>${evils.length > 0 ? evils.join(", ") : "ãªã—"}<br><small>â€»ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰ã®æ­£ä½“ã¯è¦‹ãˆã¾ã›ã‚“</small>`;
        } else if (me.role === "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«") {
            const targets = all.filter(p => p.role === "ãƒãƒ¼ãƒªãƒ³" || p.role === "ãƒ¢ãƒ«ã‚¬ãƒŠ").map(p => p.name);
            info = `<b>âœ¨ ãƒãƒ¼ãƒªãƒ³å€™è£œ:</b><br>${targets.join(", ")}<br><small>â€»ä¸€æ–¹ã¯ãƒ¢ãƒ«ã‚¬ãƒŠï¼ˆé‚ªæ‚ªï¼‰ã§ã™</small>`;
        } else if (me.side === "Evil") {
            const friends = all.filter(p => p.side === "Evil" && p.id != myId && p.role !== "ã‚ªãƒ™ãƒ­ãƒ³").map(p => p.name);
            info = `<b>ğŸ˜ˆ é‚ªæ‚ªãªä»²é–“:</b><br>${friends.length > 0 ? friends.join(", ") : "ãªã—"}<br><small>â€»ã‚ªãƒ™ãƒ­ãƒ³ã¯ãŠäº’ã„ã«è¦‹ãˆã¾ã›ã‚“</small>`;
        } else {
            info = "ç‰¹åˆ¥ãªåŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è©±ã—åˆã„ã®ä¸­ã§é‚ªæ‚ªã‚’è¦‹ã¤ã‘å‡ºã—ã¾ã—ã‚‡ã†ã€‚";
        }
        document.getElementById('role-desc').innerHTML = info;

        // 3. ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†UIï¼ˆææ¡ˆã‚„æŠ•ç¥¨ã®ãƒœã‚¿ãƒ³ã‚’å‡ºã™å ´æ‰€ï¼‰
        const actionArea = document.getElementById('action-area');
        const waitingMsg = document.getElementById('waiting-msg');

        if (!data.phase || data.phase === 'PROPOSING') {
            waitingMsg.innerText = `ãƒªãƒ¼ãƒ€ãƒ¼: ${leaderName}`;
            if (isLeader) {
                actionArea.innerHTML = `
                    <h4 style="margin:0 0 10px 0;">é å¾ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„</h4>
                    <div style="text-align:left; background:rgba(255,255,255,0.05); padding:10px; border-radius:5px;">
                        ${all.map(p => `<div><label><input type="checkbox" class="team-check" value="${p.id}"> ${p.name}</label></div>`).join('')}
                    </div>
                    <button class="btn" onclick="sendProposal()">ææ¡ˆã‚’ç¢ºå®šã™ã‚‹</button>
                `;
            } else {
                actionArea.innerHTML = "<p>ãƒªãƒ¼ãƒ€ãƒ¼ã®ææ¡ˆã‚’å¾…ã£ã¦ã„ã¾ã™...</p>";
            }
        } 
        else if (data.phase === 'VOTING') {
            const teamIds = data.currentProposal || [];
            const teamNames = teamIds.map(id => data.players[id].name).join(", ");
            waitingMsg.innerText = "ãƒãƒ¼ãƒ æ‰¿èªæŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º";
            
            if (!data.votes || data.votes[myId] === undefined) {
                actionArea.innerHTML = `
                    <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px;">
                        <p style="margin-top:0;">ææ¡ˆã•ã‚ŒãŸãƒãƒ¼ãƒ :<br><b style="color:var(--accent)">${teamNames}</b></p>
                        <div style="display:flex; gap:10px;">
                            <button class="btn" style="background:var(--blue)" onclick="castVote(true)">æ‰¿èª</button>
                            <button class="btn" style="background:var(--red)" onclick="castVote(false)">å´ä¸‹</button>
                        </div>
                    </div>
                `;
            } else {
                actionArea.innerHTML = "<p style='color:#888;'>ã‚ãªãŸã®æŠ•ç¥¨ã¯å®Œäº†ã—ã¾ã—ãŸã€‚<br>å…¨å“¡ã®å®Œäº†ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>";
            }
        }
        else if (data.phase === 'MISSION') {
            const isMember = (data.currentProposal || []).includes(String(myId));
            waitingMsg.innerText = "é å¾ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼‰ä¸­...";
            if (isMember) {
                if (!data.missions || data.missions[myId] === undefined) {
                    actionArea.innerHTML = `
                        <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; border:2px solid var(--accent);">
                            <p>ã‚ãªãŸã¯é å¾ãƒ¡ãƒ³ãƒãƒ¼ã§ã™ã€‚<br>ã“ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’...</p>
                            <div style="display:flex; gap:10px;">
                                <button class="btn" style="background:var(--blue)" onclick="castMission(true)">æˆåŠŸã•ã›ã‚‹</button>
                                ${me.side === 'Evil' ? `<button class="btn" style="background:var(--red)" onclick="castMission(false)">å¤±æ•—ã•ã›ã‚‹</button>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    actionArea.innerHTML = "<p>ãƒŸãƒƒã‚·ãƒ§ãƒ³å ±å‘Šå®Œäº†ã€‚çµæœã‚’å¾…ã£ã¦ã„ã¾ã™...</p>";
                }
            } else {
                actionArea.innerHTML = "<p>é å¾ãƒ¡ãƒ³ãƒãƒ¼ã®å ±å‘Šã‚’å¾…ã£ã¦ã„ã¾ã™...</p>";
            }
        }
    }
    // --- ã“ã“ã‹ã‚‰ä¸‹ã¯æ–°ã—ã„é–¢æ•°ã¨ã—ã¦è¿½åŠ  ---
    window.sendProposal = () => {
        const selected = Array.from(document.querySelectorAll('.team-check:checked')).map(el => el.value);
        if (selected.length === 0) return alert("é å¾ã«è¡Œãäººã‚’é¸ã‚“ã§ï¼");
        
        update(ref(db, `rooms/${roomId}`), {
            currentProposal: selected,
            phase: 'VOTING',
            votes: null
        });
    };

    window.castVote = (val) => {
        set(ref(db, `rooms/${roomId}/votes/${myId}`), val);
    };
</script>
</body>
</html>
