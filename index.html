<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Avalon Online - Fully Synced</title>
    <style>
        :root { --primary: #e94560; --bg: #1a1a2e; --card: #16213e; --accent: #f1c40f; --blue: #3498db; --red: #e74c3c; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: #e9e9e9; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding-bottom: 50px; }
        
        .quest-tracker { display: flex; justify-content: center; gap: 10px; padding: 15px; background: rgba(0,0,0,0.8); width: 100%; border-bottom: 2px solid #333; position: sticky; top: 0; z-index: 50; }
        .quest-node { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #555; display: flex; align-items: center; justify-content: center; font-weight: bold; background: #222; }
        .node-active { border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .node-success { background: var(--blue) !important; border-color: white !important; }
        .node-fail { background: var(--red) !important; border-color: white !important; }
        
        .main-container { width: 100%; max-width: 500px; padding: 20px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #0f3460; }
        .btn { background: var(--primary); border: none; color: white; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn:disabled { background: #444; cursor: not-allowed; }
        
        .player-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; align-items: center; }
        .info-tag { font-size: 0.8em; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white; }

        #custom-confirm, #overlay, #assassin-reveal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 5000; background: rgba(0,0,0,0.9); text-align: center; }
        .confirm-card { background: var(--card); border: 2px solid var(--accent); padding: 25px; border-radius: 15px; max-width: 350px; }
    </style>
</head>
<body>

<div class="quest-tracker">
    <div class="quest-node" id="node-1">1</div>
    <div class="quest-node" id="node-2">2</div>
    <div class="quest-node" id="node-3">3</div>
    <div class="quest-node" id="node-4">4</div>
    <div class="quest-node" id="node-5">5</div>
</div>

<div class="main-container">
    <div id="lobby-screen" class="card">
        <h3>ğŸ° ãƒ­ãƒ“ãƒ¼: <span id="room-id-display"></span></h3>
        <div id="join-controls">
            <input type="text" id="player-name" placeholder="åå‰" style="width:80%; padding:10px; margin-bottom:10px;">
            <button class="btn" onclick="joinGame()">å…¥å®¤</button>
        </div>
        <div id="player-list-area" style="text-align:left; margin-top:20px;">
            <h4>å¾…æ©Ÿä¸­ (<span id="p-count">0</span>)</h4>
            <ul id="p-list"></ul>
        </div>
        <button id="start-btn" class="btn" style="display:none; background:var(--accent); color:#000;" onclick="dealRoles()">å½¹è·é…å¸ƒã—ã¦é–‹å§‹</button>
    </div>

    <div id="game-screen" style="display:none;">
        <div class="card">
            <h3>å½¹è·: <span id="my-role" style="color:var(--accent)">-</span></h3>
            <div id="my-purpose" style="font-weight:bold; color:var(--accent); font-size:0.9em;"></div>
            <div id="my-skill" style="font-size:0.85em; margin-top:10px; background:rgba(0,0,0,0.3); padding:10px; border-radius:5px;"></div>
        </div>

        <div id="interaction-area" class="card">
            <h4 id="status-msg">ãƒªãƒ¼ãƒ€ãƒ¼ã®ææ¡ˆã‚’å¾…ã£ã¦ã„ã¾ã™...</h4>
            <div id="proposal-controls" style="display:none;">
                <div id="member-select-list"></div>
                <button class="btn" onclick="proposeTeam()">ãƒãƒ¼ãƒ ã‚’ææ¡ˆã™ã‚‹</button>
            </div>
            <div id="vote-controls" style="display:none;">
                <p id="proposed-team-display"></p>
                <div style="display:flex; gap:10px;">
                    <button class="btn" style="background:var(--blue)" onclick="castVote(true)">æ‰¿èª</button>
                    <button class="btn" style="background:var(--red)" onclick="castVote(false)">å´ä¸‹</button>
                </div>
            </div>
            <div id="mission-controls" style="display:none;">
                <p>ä»»å‹™ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                <div style="display:flex; gap:10px;">
                    <button class="btn" style="background:var(--blue)" onclick="castMission(true)">æˆåŠŸ</button>
                    <button id="fail-btn" class="btn" style="background:var(--red)" onclick="castMission(false)">å¤±æ•—</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="custom-confirm">
    <div class="confirm-card">
        <h3>âš ï¸ æœ€å¾Œã®å¬é›†</h3>
        <p id="confirm-msg"></p>
        <button class="btn" onclick="closeConfirm()">æˆ»ã‚‹</button>
        <button class="btn" style="background:var(--accent); color:#000;" onclick="startForcedMission()">å‡ºç™º</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAe0JL5gdcLJ16GTuTd9fU-MHeHaILbpCY",
        authDomain: "avalon-online-51a54.firebaseapp.com",
        databaseURL: "https://avalon-online-51a54-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "avalon-online-51a54",
        appId: "1:557710503935:web:f50ee0e3e2febe328601ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room') || 'take-room';
    document.getElementById('room-id-display').innerText = roomId;

    let myId = sessionStorage.getItem('avalon_id');
    let gameState = {};

    window.joinGame = async () => {
        const name = document.getElementById('player-name').value;
        if(!name) return;
        const snap = await get(ref(db, `rooms/${roomId}/players`));
        const count = snap.exists() ? Object.keys(snap.val()).length : 0;
        myId = count;
        sessionStorage.setItem('avalon_id', myId);
        await set(ref(db, `rooms/${roomId}/players/${myId}`), { id: myId, name: name });
        document.getElementById('join-controls').innerHTML = `<p>å…¥å®¤ä¸­: ${name}</p>`;
    };

    onValue(ref(db, `rooms/${roomId}`), (snap) => {
        if(!snap.exists()) return;
        gameState = snap.val();
        updateUI();
    });

    function updateUI() {
        const players = gameState.players ? Object.values(gameState.players) : [];
        document.getElementById('p-count').innerText = players.length;
        document.getElementById('p-list').innerHTML = players.map(p => `<li>${p.name} ${p.id==0?'(Host)':''}</li>`).join('');
        
        if(myId == 0 && players.length >= 5 && !gameState.status) {
            document.getElementById('start-btn').style.display = 'block';
        }

        if(gameState.status === "STARTED") {
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            const me = players.find(p => p.id == myId);
            renderRole(me, players);
            renderGameFlow(me, players);
        }
    }

    window.dealRoles = async () => {
        const players = Object.values(gameState.players);
        let roles = ["ãƒãƒ¼ãƒªãƒ³", "æš—æ®ºè€…", "æ­£ç¾©ã®å¿ è‡£", "æ­£ç¾©ã®å¿ è‡£", "é‚ªæ‚ªã®æ‰‹å…ˆ", "æ­£ç¾©ã®å¿ è‡£", "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«", "ãƒ¢ãƒ«ã‚¬ãƒŠ"].slice(0, players.length);
        roles.sort(() => Math.random() - 0.5);
        
        const updates = { status: "STARTED", round: 1, leaderIdx: 0, rejectCount: 0, scoreG: 0, scoreE: 0 };
        players.forEach((p, i) => {
            updates[`players/${p.id}/role`] = roles[i];
            updates[`players/${p.id}/side`] = ["æš—æ®ºè€…", "æ‰‹å…ˆ", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰"].some(r => roles[i].includes(r)) ? "Evil" : "Good";
        });
        update(ref(db, `rooms/${roomId}`), updates);
    };

    function renderRole(me, all) {
        document.getElementById('my-role').innerText = me.role;
        document.getElementById('my-purpose').innerText = me.side === "Good" ? "ã€ç›®çš„ã€‘é å¾ã‚’3å›æˆåŠŸã•ã›ã‚ˆ" : "ã€ç›®çš„ã€‘3å›å¤±æ•—ã•ã›ã‚‹ã‹æš—æ®ºã›ã‚ˆ";
        
        let skillText = "ç‰¹åˆ¥ãªåŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        if(me.role === "ãƒãƒ¼ãƒªãƒ³") {
            const evils = all.filter(p => p.side === "Evil" && p.role !== "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰").map(p => p.name);
            skillText = `ã€é‚ªæ‚ªãªè€…ã€‘${evils.join(", ")}`;
        } else if(me.side === "Evil") {
            const evils = all.filter(p => p.side === "Evil").map(p => p.name);
            skillText = `ã€ä»²é–“ã€‘${evils.join(", ")}`;
        }
        document.getElementById('my-skill').innerText = skillText;
    }

    function renderGameFlow(me, all) {
        const isLeader = (gameState.leaderIdx == myId);
        const leaderName = all.find(p => p.id == gameState.leaderIdx).name;
        
        // 1. ææ¡ˆãƒ•ã‚§ãƒ¼ã‚º
        if(!gameState.currentProposal) {
            document.getElementById('status-msg').innerText = `${leaderName}ãŒãƒãƒ¼ãƒ ã‚’é¸è€ƒä¸­...`;
            document.getElementById('proposal-controls').style.display = isLeader ? 'block' : 'none';
            document.getElementById('member-select-list').innerHTML = all.map(p => `<div><input type="checkbox" class="p-sel" value="${p.id}"> ${p.name}</div>`).join('');
        } 
        // 2. æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º
        else if(gameState.currentProposal && !gameState.votes) {
            document.getElementById('status-msg').innerText = "æŠ•ç¥¨ä¸­...";
            document.getElementById('proposal-controls').style.display = 'none';
            document.getElementById('vote-controls').style.display = 'block';
        }
    }

    window.proposeTeam = () => {
        const selected = Array.from(document.querySelectorAll('.p-sel:checked')).map(el => el.value);
        update(ref(db, `rooms/${roomId}/currentProposal`), selected);
    };

    window.castVote = (val) => {
        update(ref(db, `rooms/${roomId}/votes/${myId}`), val);
        document.getElementById('vote-controls').style.display = 'none';
    };

</script>
</body>
</html>
