<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Avalon Online - Master</title>
    <style>
        :root { --primary: #e94560; --bg: #1a1a2e; --card: #16213e; --accent: #f1c40f; --blue: #3498db; --red: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; text-align: center; margin: 0; padding-bottom: 50px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; max-width: 500px; margin: 20px auto; border: 1px solid #0f3460; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
        .btn:disabled { background: #444; cursor: not-allowed; }
        input { width: 90%; padding: 12px; margin: 10px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; }
        .p-item { padding: 10px; border-bottom: 1px solid #333; text-align: left; display: flex; justify-content: space-between; }
        .quest-node { display: inline-block; width: 40px; height: 40px; border-radius: 50%; border: 2px solid #555; line-height: 40px; margin: 5px; }
        .node-active { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .node-success { background: var(--blue); border-color: #fff; }
        .node-fail { background: var(--red); border-color: #fff; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; font-size: 3em; font-weight: bold; }
    </style>
</head>
<body>

<div id="overlay"></div>

<div id="lobby-screen" class="card">
    <h2>ğŸ° ãƒ«ãƒ¼ãƒ : <span id="room-display">...</span></h2>
    <div id="join-area">
        <input type="text" id="player-name" placeholder="åå‰ã‚’å…¥åŠ›">
        <button class="btn" onclick="joinGame()">å…¥å®¤ã™ã‚‹</button>
    </div>
    <div style="margin-top:20px;">
        <h4>å‚åŠ è€… (<span id="player-count">0</span>)</h4>
        <div id="list-items"></div>
    </div>
    <button id="start-btn" class="btn" style="display:none; background:var(--accent); color:#000;" onclick="setupRoles()">å½¹è·é…å¸ƒã—ã¦é–‹å§‹</button>
</div>

<div id="game-screen" style="display:none;">
    <div id="quest-track" class="card" style="background:rgba(0,0,0,0.5);">
        <div class="quest-node" id="n1">1</div><div class="quest-node" id="n2">2</div><div class="quest-node" id="n3">3</div><div class="quest-node" id="n4">4</div><div class="quest-node" id="n5">5</div>
        <div id="reject-info" style="font-size:0.8em; color:var(--accent); margin-top:5px;"></div>
    </div>

    <div class="card">
        <h3 id="my-role-display" style="color:var(--accent); margin:5px 0;"></h3>
        <div id="my-skill-display" style="font-size:0.85em; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;"></div>
    </div>

    <div id="action-card" class="card">
        <h3 id="phase-title">ãƒªãƒ¼ãƒ€ãƒ¼ã®ææ¡ˆå¾…ã¡</h3>
        <div id="phase-content"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAe0JL5gdcLJ16GTuTd9fU-MHeHaILbpCY",
        authDomain: "avalon-online-51a54.firebaseapp.com",
        databaseURL: "https://avalon-online-51a54-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "avalon-online-51a54",
        appId: "1:557710503935:web:f50ee0e3e2febe328601ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room') || 'default-room';
    document.getElementById('room-display').innerText = roomId;
    let myId = sessionStorage.getItem('avalon_myId');
    const questData = {5:[2,3,2,3,3], 6:[2,3,4,3,4], 7:[2,3,3,4,4], 8:[3,4,4,5,5], 9:[3,4,4,5,5], 10:[3,4,4,5,5]};

    window.joinGame = async () => {
        const name = document.getElementById('player-name').value;
        if(!name) return;
        const snap = await get(ref(db, `rooms/${roomId}/players`));
        myId = snap.exists() ? Object.keys(snap.val()).length : 0;
        sessionStorage.setItem('avalon_myId', myId);
        await set(ref(db, `rooms/${roomId}/players/${myId}`), { id: myId, name: name });
        document.getElementById('join-area').innerHTML = `âœ… å…¥å®¤å®Œäº†`;
    };

    onValue(ref(db, `rooms/${roomId}`), (snap) => {
        const data = snap.val(); if(!data) return;
        const players = data.players ? Object.values(data.players) : [];
        
        // ãƒ­ãƒ“ãƒ¼æ›´æ–°
        document.getElementById('player-count').innerText = players.length;
        document.getElementById('list-items').innerHTML = players.map(p => `<div class="p-item">${p.name} ${p.id==0?'ğŸ‘‘':''}</div>`).join('');
        if(myId == 0 && players.length >= 5 && data.status !== 'STARTED') document.getElementById('start-btn').style.display = 'block';

        if(data.status === 'STARTED') renderGame(data, players);
    });

    window.setupRoles = async () => {
        const snap = await get(ref(db, `rooms/${roomId}/players`));
        const players = Object.values(snap.val());
        const count = players.length;
        const gRoles = ["ãƒãƒ¼ãƒªãƒ³", "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«", "æ­£ç¾©ã®å¿ è‡£", "æ­£ç¾©ã®å¿ è‡£", "æ­£ç¾©ã®å¿ è‡£", "æ­£ç¾©ã®å¿ è‡£"];
        const eRoles = ["æš—æ®ºè€…", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰", "ã‚ªãƒ™ãƒ­ãƒ³", "é‚ªæ‚ªã®æ‰‹å…ˆ"];
        let gCount = (count >= 9) ? 6 : (count >= 7) ? 4 : (count === 8) ? 5 : 3;
        let pool = [...gRoles.slice(0, gCount), ...eRoles.slice(0, count - gCount)].sort(() => Math.random() - 0.5);
        
        const updates = { status: 'STARTED', round: 1, leaderIdx: 0, rejectCount: 0, scoreG: 0, scoreE: 0, phase: 'PROPOSING' };
        players.forEach((p, i) => {
            updates[`players/${p.id}/role`] = pool[i];
            updates[`players/${p.id}/side`] = ["æš—æ®ºè€…", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰", "æ‰‹å…ˆ"].some(r => pool[i].includes(r)) ? "Evil" : "Good";
        });
        update(ref(db, `rooms/${roomId}`), updates);
    };

    function renderGame(data, players) {
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        const me = players.find(p => p.id == myId);
        
        // ã‚¯ã‚¨ã‚¹ãƒˆè¡¨ç¤º
        for(let i=1; i<=5; i++) {
            const el = document.getElementById(`n${i}`);
            el.className = 'quest-node' + (i == data.round ? ' node-active' : '');
            if(data.history && data.history[i]) el.classList.add(data.history[i] === 'SUCCESS' ? 'node-success' : 'node-fail');
        }
        document.getElementById('reject-info').innerText = `å¦æ±ºå›æ•°: ${data.rejectCount} / 5`;

        // å½¹è·è¡¨ç¤º
        document.getElementById('my-role-display').innerText = `å½¹è·: ${me.role}`;
        let skill = "ç‰¹ã«ãªã—";
        if(me.role === "ãƒãƒ¼ãƒªãƒ³") skill = "é‚ªæ‚ª: " + players.filter(p => p.side === "Evil" && p.role !== "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰").map(p => p.name).join(", ");
        else if(me.role === "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«") skill = "å€™è£œ: " + players.filter(p => ["ãƒãƒ¼ãƒªãƒ³", "ãƒ¢ãƒ«ã‚¬ãƒŠ"].includes(p.role)).map(p => p.name).join(", ");
        else if(me.side === "Evil") skill = "ä»²é–“: " + players.filter(p => p.side === "Evil" && p.id != myId).map(p => p.name).join(", ");
        document.getElementById('my-skill-display').innerText = skill;

        // ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†
        const content = document.getElementById('phase-content');
        const isLeader = data.leaderIdx == myId;

        if(data.phase === 'PROPOSING') {
            document.getElementById('phase-title').innerText = `${players[data.leaderIdx].name}ãŒãƒãƒ¼ãƒ é¸è€ƒä¸­`;
            if(isLeader) {
                content.innerHTML = players.map(p => `<div><input type="checkbox" class="team-sel" value="${p.id}"> ${p.name}</div>`).join('') + `<button class="btn" onclick="sendProposal()">ææ¡ˆã™ã‚‹</button>`;
            } else content.innerHTML = "ãƒªãƒ¼ãƒ€ãƒ¼ã®é¸æŠã‚’å¾…ã£ã¦ãã ã•ã„...";
        } 
        else if(data.phase === 'VOTING') {
            const teamNames = data.currentProposal.map(id => players[id].name).join(", ");
            document.getElementById('phase-title').innerText = "ãƒãƒ¼ãƒ æ‰¿èªæŠ•ç¥¨";
            content.innerHTML = `<p>ææ¡ˆãƒ¡ãƒ³ãƒãƒ¼: <b>${teamNames}</b></p>` + `<div style="display:flex;gap:10px;"><button class="btn" style="background:var(--blue)" onclick="vote(true)">æ‰¿èª</button><button class="btn" style="background:var(--red)" onclick="vote(false)">å´ä¸‹</button></div>`;
        }
        else if(data.phase === 'MISSION') {
            document.getElementById('phase-title').innerText = "é å¾ä¸­...";
            if(data.currentProposal.includes(String(myId))) {
                content.innerHTML = `<p>ä»»å‹™ã‚’é¸ã‚“ã§ãã ã•ã„</p><div style="display:flex;gap:10px;"><button class="btn" style="background:var(--blue)" onclick="mission(true)">æˆåŠŸ</button>` + (me.side === "Evil" ? `<button class="btn" style="background:var(--red)" onclick="mission(false)">å¤±æ•—</button>` : "") + `</div>`;
            } else content.innerHTML = "ãƒ¡ãƒ³ãƒãƒ¼ã®å ±å‘Šã‚’å¾…ã£ã¦ã„ã¾ã™...";
        }
    }

    window.sendProposal = () => {
        const sel = Array.from(document.querySelectorAll('.team-sel:checked')).map(el => el.value);
        const need = questData[players.length][gameState.round - 1]; // äººæ•°ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ãªã‚‰ã“ã“
        update(ref(db, `rooms/${roomId}`), { currentProposal: sel, phase: 'VOTING', votes: {} });
    };

    window.vote = (val) => update(ref(db, `rooms/${roomId}/votes/${myId}`), val);
    window.mission = (val) => update(ref(db, `rooms/${roomId}/missions/${myId}`), val);
</script>
</body>
</html>
