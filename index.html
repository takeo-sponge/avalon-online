<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Avalon Online - Custom</title>
    <style>
        :root { --primary: #e94560; --bg: #1a1a2e; --card: #16213e; --accent: #f1c40f; --blue: #3498db; --red: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; text-align: center; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; max-width: 500px; margin: 10px auto; border: 1px solid #0f3460; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
        input[type="text"] { width: 90%; padding: 12px; margin: 10px 0; background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; }
        .player-list { text-align: left; margin: 15px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
        .config-section { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left; }
        .role-option { display: flex; align-items: center; margin: 8px 0; font-size: 0.9em; }
        .role-option input { margin-right: 10px; transform: scale(1.2); }
        .error-msg { color: var(--red); font-size: 0.8em; margin-top: 5px; display: none; }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
          /* é å¾ã‚«ãƒ¼ãƒ‰ã®æ¼”å‡ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .mission-card {
            display: inline-block;
            width: 60px;
            height: 90px;
            margin: 10px;
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 8px;
            line-height: 90px;
            font-size: 1.2em;
            font-weight: bold;
            perspective: 1000px;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: default;
        }
        .mission-card.reveal {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card-back { background: #2c3e50; color: #2c3e50; } /* ä¼ã›ã¦ã‚‹æ™‚ã¯çœŸã£æš— */
        .card-front { transform: rotateY(180deg); color: white; }
        .card-success { background: var(--blue); }
        .card-fail { background: var(--red); }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-1px, -2px) rotate(-1deg); }
            50% { transform: translate(-3px, 0px) rotate(1deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }
        .shaking { animation: shake 0.5s infinite; }

        #help-btn {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(0,0,0,0.6);
        color: white;
        border: 1px solid var(--accent, #f1c40f); /* å¤‰æ•°ãŒãªã„å ´åˆã®ãŸã‚ã«è‰²ã‚’æŒ‡å®š */
        border-radius: 50%;
        width: 35px;
        height: 35px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        }
    
        #help-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 10001;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
    
        .help-content {
            background: #222;
            border: 2px solid var(--accent, #f1c40f);
            border-radius: 10px;
            padding: 20px;
            max-width: 500px;
            margin: 40px auto;
            color: white;
        }
    </style>
</head>
<body>

<div id="setup-screen" class="card">
    <h2>ğŸ° ã‚¢ãƒ´ã‚¡ãƒ­ãƒ³ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</h2>
    <input type="text" id="player-name" placeholder="ã‚ãªãŸã®åå‰">
    <input type="text" id="room-id" placeholder="ãƒ«ãƒ¼ãƒ å">
    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:var(--accent); color:#000;" onclick="joinGame(true)">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
        <button class="btn" onclick="joinGame(false)">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>
</div>

<div id="lobby-screen" class="card" style="display:none;">
    <h3>ãƒ«ãƒ¼ãƒ : <span id="room-display" style="color:var(--accent)"></span></h3>
    <div class="player-list">
        <h4>å‚åŠ è€… (<span id="player-count">0</span>)</h4>
        <ul id="list-items" style="list-style:none; padding:0;"></ul>
    </div>

    <div id="host-panel" style="display:none;" class="config-section">
        <h4 style="margin-top:0; color:var(--accent);">ğŸ‘‘ ãƒ›ã‚¹ãƒˆè¨­å®š</h4>
        <label style="font-size:0.9em;">ãƒ—ãƒ¬ã‚¤äººæ•°ã‚’é¸æŠ:</label>
        <select id="play-limit" style="width:100%; padding:8px; margin-bottom:15px; background:#000; color:#fff;">
            <option value="5">5äºº (æ­£ç¾©3 / é‚ªæ‚ª2)</option>
            <option value="6">6äºº (æ­£ç¾©4 / é‚ªæ‚ª2)</option>
            <option value="7">7äºº (æ­£ç¾©4 / é‚ªæ‚ª3)</option>
            <option value="8">8äºº (æ­£ç¾©5 / é‚ªæ‚ª3)</option>
            <option value="9">9äºº (æ­£ç¾©6 / é‚ªæ‚ª3)</option>
            <option value="10">10äºº (æ­£ç¾©6 / é‚ªæ‚ª4)</option>
        </select>

        <label style="font-size:0.9em;">è¿½åŠ å½¹è·ã®é¸æŠ:</label>
        <div class="role-option"><input type="checkbox" checked disabled> ãƒãƒ¼ãƒªãƒ³ (å¿…é ˆ)</div>
        <div class="role-option"><input type="checkbox" id="role-percival"> ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ« (æ­£ç¾©)</div>
        <div class="role-option"><input type="checkbox" checked disabled> æš—æ®ºè€… (å¿…é ˆ)</div>
        <div class="role-option"><input type="checkbox" id="role-morgana"> ãƒ¢ãƒ«ã‚¬ãƒŠ (é‚ªæ‚ª)</div>
        <div class="role-option"><input type="checkbox" id="role-mordred"> ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰ (é‚ªæ‚ª)</div>
        <div class="role-option"><input type="checkbox" id="role-oberon"> ã‚ªãƒ™ãƒ­ãƒ³ (é‚ªæ‚ª)</div>
        <p id="role-error" class="error-msg">âš ï¸ äººæ•°ã¨å½¹è·ã®æ•°ãŒåˆã„ã¾ã›ã‚“ï¼</p>
        <button class="btn" style="background:var(--accent); color:#000;" onclick="setupRoles()">è¨­å®šã‚’ç¢ºå®šã—ã¦é–‹å§‹</button>
    </div>

    <div id="guest-msg" style="display:none; font-size:0.8em; color:#888;">ãƒ›ã‚¹ãƒˆãŒè¨­å®šã‚’å®Œäº†ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
    ã€€<div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 15px;">
    ã€€<span style="font-size: 0.7em; color: #666; display: block; margin-bottom: 5px;">åˆ¥ã®åå‰ã§å…¥ã‚Šç›´ã—ãŸã„å ´åˆã¯ï¼š</span>
    ã€€<button class="btn" style="background:transparent; border: 1px solid #444; color:#888; font-size:0.75em; width: auto; padding: 5px 15px;" onclick="leaveGame()">æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦é€€å‡º</button>
ã€€ã€€ã€€</div>
     </div>

<div id="game-screen" style="display:none;" class="card">
    <div id="mission-track" style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
        <div class="round-circle" id="round-1" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">1</div>
        <div class="round-circle" id="round-2" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">2</div>
        <div class="round-circle" id="round-3" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">3</div>
        <div class="round-circle" id="round-4" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">4</div>
        <div class="round-circle" id="round-5" style="width:40px; height:40px; border-radius:50%; border:2px solid #444; display:flex; align-items:center; justify-content:center; font-weight:bold;">5</div>
    </div>

    

    <h3 id="my-role-name" style="color:var(--accent); font-size:2em; margin:10px 0;"></h3>
    <div id="role-purpose" style="font-weight:bold; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;"></div>
    <div id="role-desc" style="background:rgba(0,0,0,0.4); padding:15px; border-radius:8px; text-align:left; font-size:0.9em;"></div>
    <p id="waiting-msg" style="font-size:0.9em; color:var(--accent);"></p>
    <div id="action-area" style="margin-top:15px;"></div>
    <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
    <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
    <div style="text-align: left; font-size: 0.8em; color: var(--accent); margin-bottom: 5px;">ğŸ“œ ã‚²ãƒ¼ãƒ å±¥æ­´</div>
    <div id="result-log" style="text-align: left; max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid #333;">
        <p style="color:#666; font-size:0.9em;">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
    </div>
</div> ```
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    const firebaseConfig = {
        apiKey: "AIzaSyAe0JL5gdcLJ16GTuTd9fU-MHeHaILbpCY",
        authDomain: "avalon-online-51a54.firebaseapp.com",
        databaseURL: "https://avalon-online-51a54-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "avalon-online-51a54",
        appId: "1:557710503935:web:f50ee0e3e2febe328601ca"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", roomId = "", myId = null;
    let lastProcessedVoteKey = "";
    let lastProcessedMissionKey = "";
    // FirebaseåˆæœŸåŒ–ãªã©ã®ã™ãä¸‹ã«è¿½åŠ 
    window.onload = () => {
        const savedName = localStorage.getItem('avalon_name');
        const savedRoom = localStorage.getItem('avalon_room');
        if (savedName && savedRoom) {
            document.getElementById('player-name').value = savedName;
            document.getElementById('room-id').value = savedRoom;
        }
    };

    window.leaveGame = () => {
        if(confirm("ä¿å­˜æƒ…å ±ã‚’æ¶ˆã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
            localStorage.clear();
            location.reload();
        }
    };

    window.joinGame = async function(isHostRequest) {
        myName = document.getElementById('player-name').value.trim();
        roomId = document.getElementById('room-id').value.trim();
        if (!myName || !roomId) return alert("å…¥åŠ›ã—ã¦ã­ï¼");
        localStorage.setItem('avalon_name', myName);
        localStorage.setItem('avalon_room', roomId);
        localStorage.setItem('avalon_isHost', isHostRequest);
        const roomRef = ref(db, `rooms/${roomId}`);
        const snap = await get(roomRef);
        if (isHostRequest) await update(roomRef, { hostName: myName });
        const pSnap = await get(ref(db, `rooms/${roomId}/players`));
        const players = pSnap.val() || {};
        let foundId = Object.keys(players).find(id => players[id].name === myName);
        if (foundId === undefined) {
            foundId = Object.keys(players).length;
            await set(ref(db, `rooms/${roomId}/players/${foundId}`), { id: foundId, name: myName });
        }
        myId = foundId;
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'block';
        document.getElementById('room-display').innerText = roomId;
        createLogArea();

        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„æ™‚ã¯ä½•ã‚‚ã—ãªã„
            const pList = data.players ? Object.values(data.players) : [];
            document.getElementById('player-count').innerText = pList.length;
            // ğŸš© ä¿®æ­£ï¼šãƒ•ãƒ©ãƒƒã‚°ãŒå‡ºã‚‹ã‚ˆã†ã«æ¯”è¼ƒã‚’ == ã«å¤‰æ›´
            document.getElementById('list-items').innerHTML = pList.map(p => {
                const isLeader = p.id == data.leaderIdx; 
                const isHost = p.name === data.hostName;
                return `<li>${isLeader ? 'ğŸš© ' : 'ğŸ‘¤ '} ${p.name} ${isHost ? 'ğŸ‘‘' : ''}</li>`;
            }).join('');

            if (data.hostName === myName) {
                document.getElementById('host-panel').style.display = 'block';
            } else {
                document.getElementById('guest-msg').style.display = 'block';
            }
            if (data.status === 'STARTED' || data.status === 'FINISHED') {
                showGame(data);
                if (data.status === 'STARTED' && myName === data.hostName) {
                    handleAutoJudgment(data, pList);
                }
            }
        });
    };

    window.setupRoles = async function() {
        const limit = parseInt(document.getElementById('play-limit').value);
        const snap = await get(ref(db, `rooms/${roomId}/players`));
        if (!snap.exists()) {
            alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä¸€äººã‚‚ã„ã¾ã›ã‚“ï¼");
            return;
        }
        const currentPlayers = Object.values(snap.val());
        if (currentPlayers.length !== limit) {
            alert(`ã‚¨ãƒ©ãƒ¼ï¼šè¨­å®šã•ã‚ŒãŸäººæ•°(${limit}äºº)ã¨ç¾åœ¨ã®å‚åŠ äººæ•°(${currentPlayers.length}äºº)ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼`);
            return;
        }
        // é™£å–¶ã”ã¨ã®äººæ•°å®šç¾©
        const config = { 5: [3, 2], 6: [4, 2], 7: [4, 3], 8: [5, 3], 9: [6, 3], 10: [6, 4] };
        const [gNeed, eNeed] = config[limit];
        let goodRoles = ["ãƒãƒ¼ãƒªãƒ³"];
        if (document.getElementById('role-percival').checked) goodRoles.push("ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«");
        while (goodRoles.length < gNeed) goodRoles.push("æ­£ç¾©ã®å¿ è‡£");
        let evilRoles = ["æš—æ®ºè€…"];
        if (document.getElementById('role-morgana').checked) evilRoles.push("ãƒ¢ãƒ«ã‚¬ãƒŠ");
        if (document.getElementById('role-mordred').checked) evilRoles.push("ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰");
        if (document.getElementById('role-oberon').checked) evilRoles.push("ã‚ªãƒ™ãƒ­ãƒ³");
        while (evilRoles.length < eNeed) evilRoles.push("é‚ªæ‚ªã®æ‰‹å…ˆ");
        if (goodRoles.length > gNeed || evilRoles.length > eNeed) {
            alert("ã‚¨ãƒ©ãƒ¼ï¼šé¸ã‚“ã å½¹è·ã®æ•°ãŒã€é™£å–¶ã®å®šå“¡ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼");
            return;
        }
        let pool = [...goodRoles, ...evilRoles].sort(() => Math.random() - 0.5);
        // --- ä¿®æ­£å¾Œï¼šãƒªãƒ¼ãƒ€ãƒ¼(leaderIdx)ã‚„ãƒ•ã‚§ãƒ¼ã‚ºã‚’ã—ã£ã‹ã‚Šè¨­å®šã™ã‚‹ ---
        const updates = { 
            status: 'STARTED',
            phase: 'PROPOSING', 
            leaderIdx: 0,        // æœ€åˆã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒªãƒ¼ãƒ€ãƒ¼ã«ã™ã‚‹
            votes: null,         // å¿µã®ãŸã‚åˆæœŸåŒ–
            missions: null       // å¿µã®ãŸã‚åˆæœŸåŒ–
        };
        currentPlayers.forEach((p, i) => {
            const roleName = pool[i];
            updates[`players/${p.id}/role`] = roleName;
            // é‚ªæ‚ªãªå½¹è·ãƒªã‚¹ãƒˆã«åå‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const evilRoles = ["æš—æ®ºè€…", "ãƒ¢ãƒ«ã‚¬ãƒŠ", "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰", "ã‚ªãƒ™ãƒ­ãƒ³", "é‚ªæ‚ªã®æ‰‹å…ˆ"];
            updates[`players/${p.id}/side`] = evilRoles.includes(roleName) ? "Evil" : "Good";
        });
        update(ref(db, `rooms/${roomId}`), updates);
    };
    
   function showGame(data) {
       if (!document.getElementById('help-btn')) {
        const btn = document.createElement('button');
        btn.id = 'help-btn';
        btn.innerText = '?';
        btn.onclick = () => {
            const roles = data.roles || (data.config ? data.config.roles : []);
            
            // ç¢ºèªç”¨ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆF12ã§ç¢ºèªã§ãã‚‹ï¼‰
            console.log("ç¾åœ¨ã®Roomãƒ‡ãƒ¼ã‚¿:", data);
            console.log("å–å¾—ã—ãŸå½¹è·ãƒªã‚¹ãƒˆ:", roles);
            // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã«ã€ä»Šã®ã‚²ãƒ¼ãƒ ã®å½¹è·ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
            window.toggleHelp(data.roles || []);
        };
        document.body.appendChild(btn);
    }
        if (!data.players || data.leaderIdx === undefined) return;
        const me = data.players[myId];
        const all = Object.values(data.players);
        const isLeader = data.leaderIdx == myId;
        const leaderName = data.players[data.leaderIdx] ? data.players[data.leaderIdx].name : "ãƒªãƒ¼ãƒ€ãƒ¼";

       //ã“ã“ã«æ¼”å‡ºç”¨è¿½åŠ ã—ã¦ã¿ã‚‹
       if (data.status === 'STARTED' && !window.hasShownIntro) {
        window.hasShownIntro = true; // 1å›ã ã‘å‡ºã™ãŸã‚ã®ãƒ•ãƒ©ã‚°
        showRoleIntroduction(me.role);
        }  

       // ã‚¹ã‚³ã‚¢è¡¨ç¤º
        const history = data.missionHistory || [];
        for (let i = 1; i <= 5; i++) {
            const el = document.getElementById(`round-${i}`);
            const result = history[i - 1];
            el.style.background = result === true ? "var(--blue)" : (result === false ? "var(--red)" : "transparent");
            el.style.borderColor = (result === true || result === false) ? "transparent" : "#444";
        }
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';

        // å½¹è·è¡¨ç¤º
        document.getElementById('my-role-name').innerText = me.role;
        const sideColor = me.side === "Good" ? "#3498db" : "#e74c3c";
        document.getElementById('role-purpose').innerHTML = `
            <span style="color:${sideColor}; font-size:1.2em;">ã€${me.side === "Good" ? "æ­£ç¾©" : "é‚ªæ‚ª"}é™£å–¶ã€‘</span><br>
            <span style="font-size:0.8em; opacity:0.8;">${me.side === "Good" ? "é å¾ã‚’3å›æˆåŠŸã•ã›ã‚ˆï¼" : "é å¾ã‚’3å›å¤±æ•—ã•ã›ã‚‹ã‹ã€ãƒãƒ¼ãƒªãƒ³ã‚’æš—æ®ºã›ã‚ˆï¼"}</span>
        `;

        // ã‚¹ã‚­ãƒ«èª¬æ˜ï¼ˆä¸­èº«ã¯çœç•¥ã›ãšã«ä¿æŒï¼‰
        let info = "";
        if (me.role === "ãƒãƒ¼ãƒªãƒ³") {
            const evils = all.filter(p => p.side === "Evil" && p.role !== "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰").map(p => p.name);
            info = `<b>ğŸ”® äºˆè¦‹ã—ãŸé‚ªæ‚ªãªè€…:</b><br>${evils.join(", ") || "ãªã—"}`;
        } else if (me.role === "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«") {
            const targets = all.filter(p => p.role === "ãƒãƒ¼ãƒªãƒ³" || p.role === "ãƒ¢ãƒ«ã‚¬ãƒŠ").map(p => p.name);
            info = `<b>âœ¨ ãƒãƒ¼ãƒªãƒ³å€™è£œ:</b><br>${targets.join(", ")}`;
        } else if (me.role === "ã‚ªãƒ™ãƒ­ãƒ³") {
            // ğŸš© ã“ã“ã‚’è¿½åŠ ï¼šã‚ªãƒ™ãƒ­ãƒ³æœ¬äººã«ã¯èª°ã‚‚è¦‹ãˆãªã„
            info = "<b>âš ï¸ å­¤ç‹¬ãªé‚ªæ‚ª:</b><br>ã‚ãªãŸã¯é‚ªæ‚ªé™£å–¶ã§ã™ãŒã€ä»²é–“ã‚’çŸ¥ã‚‹ã“ã¨ã¯ã§ããšã€ä»²é–“ã‚‚ã‚ãªãŸã‚’çŸ¥ã‚Šã¾ã›ã‚“ã€‚";
        } else if (me.side === "Evil") {
            // ğŸš© ã“ã“ã‚’ä¿®æ­£ï¼šä»²é–“ã‹ã‚‰ã‚ªãƒ™ãƒ­ãƒ³ã‚’é™¤å¤–
            const friends = all.filter(p => p.side === "Evil" && p.id != myId && p.role !== "ã‚ªãƒ™ãƒ­ãƒ³").map(p => p.name);
            info = `<b>ğŸ˜ˆ é‚ªæ‚ªãªä»²é–“:</b><br>${friends.join(", ") || "ãªã—"}`;
        } else {
            info = "ç‰¹åˆ¥ãªåŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è©±ã—åˆã„ã§é‚ªæ‚ªã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ã€‚";
        }
        document.getElementById('role-desc').innerHTML = info;

        // 3. UIã®å‡ºã—åˆ†ã‘
        const actionArea = document.getElementById('action-area');
        const waitingMsg = document.getElementById('waiting-msg');
       if (data.status === 'FINISHED') {
        const winnerText = data.winner === 'Good' ? 'âœ¨ æ­£ç¾©é™£å–¶ã®å‹åˆ©ï¼ âœ¨' : 'ğŸ’€ é‚ªæ‚ªé™£å–¶ã®å‹åˆ©ï¼ ğŸ’€';
        const winnerColor = data.winner === 'Good' ? 'var(--blue)' : 'var(--red)';
        const all = Object.values(data.players); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
        const resultList = all.map(p => 
            `<li style="margin-bottom:8px; list-style:none;">
                <span style="font-weight:bold; color:${p.side === 'Good' ? 'var(--blue)' : 'var(--red)'}">${p.name}</span>: 
                <span style="color:var(--accent)">${p.role}</span>
            </li>`
        ).join('');

        actionArea.innerHTML = `
            <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; border: 2px solid ${winnerColor}; margin-top: 20px;">
                <h2 style="color:${winnerColor}; margin-top:0;">${winnerText}</h2>
                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
                <h4 style="margin-bottom:10px;">ğŸ›¡ï¸ å½¹è·å…¬é–‹ ğŸ›¡ï¸</h4>
                <ul style="padding:0; text-align:center;">${resultList}</ul>
                <button class="btn" style="margin-top:20px; background:#444;" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            </div>
        `;
        waitingMsg.innerHTML = "ã‚²ãƒ¼ãƒ çµ‚äº†";
        return; // ğŸš© é‡è¦ï¼šã“ã“ã§å‡¦ç†ã‚’çµ‚ãˆã‚‹
    }
        // ğŸš© ä¿®æ­£ï¼šå„ãƒ©ã‚¦ãƒ³ãƒ‰ã®å¿…è¦äººæ•°ã‚’è¡¨ç¤º
        const roundNum = history.length + 1;
        const missionSizes = { 5:[2,3,2,3,3], 6:[2,3,4,3,4], 7:[2,3,3,4,4], 8:[3,4,4,5,5], 9:[3,4,4,5,5], 10:[3,4,4,5,5] };
        const required = missionSizes[all.length] ? missionSizes[all.length][history.length] : "?";
       let specialRuleMsg = "";
        if (all.length >= 7 && roundNum === 4) {
            specialRuleMsg = `<div style="color:var(--red); font-weight:bold; background:rgba(231, 76, 60, 0.2); padding:5px; border-radius:5px; margin-top:5px; border:1px solid var(--red); animation: blink 1s infinite;">
                                âš ï¸ ç¬¬4ãƒ©ã‚¦ãƒ³ãƒ‰ç‰¹æ®Šãƒ«ãƒ¼ãƒ«ï¼šå¤±æ•—2æšã§é å¾å¤±æ•—
                              </div>`;
        }
        const failCount = data.voteFailCount || 0;
        const resultLog = document.getElementById('result-log');
            if (resultLog) {
                // --- ğŸš© æŠ•ç¥¨ãƒ­ã‚°ã®é‡è¤‡ã‚¬ãƒ¼ãƒ‰ ---
                if (data.lastVoteResult) {
                    // ã€Œãƒ©ã‚¦ãƒ³ãƒ‰ãƒ»ã‚¿ãƒ¼ãƒ³ãƒ»çµæœã€ã‚’çµ„ã¿åˆã‚ã›ãŸå°‚ç”¨ã®ã‚­ãƒ¼ã‚’ä½œã‚‹
                    const voteKey = `v_${data.lastVoteResult.round}_${data.lastVoteResult.turn}_${data.lastVoteResult.approved}`;            
                    // ã¾ã è¡¨ç¤ºã—ã¦ã„ãªã„ã‚­ãƒ¼ã®æ™‚ã ã‘ã€HTMLã‚’è¿½åŠ ã™ã‚‹
                    if (lastProcessedVoteKey !== voteKey) {
                        const res = data.lastVoteResult;
                        const details = Object.entries(res.details).map(([id, v]) => 
                            `<span style="color:${v ? 'var(--blue)' : 'var(--red)'}">${data.players[id] ? data.players[id].name : id}${v ? 'â—¯' : 'Ã—'}</span>`
                        ).join(' ');
    
                        const newVoteLog = `
                            <div style="border-left: 4px solid ${res.approved ? 'var(--blue)' : 'var(--red)'}; padding-left: 10px; margin-bottom: 15px;">
                                <strong style="color:var(--accent)">ç¬¬ ${res.round}R - ${res.turn}å›ç›®ææ¡ˆ</strong><br>
                                <small>ãƒªãƒ¼ãƒ€ãƒ¼: ${res.leader}</small><br>
                                <small>ææ¡ˆãƒ¡ãƒ³ãƒãƒ¼: ${res.team}</small><br>
                                <div style="margin: 5px 0;">${res.approved ? 'âœ… æ‰¿èª' : 'âŒ å¦æ±º'}</div>
                                <div style="font-size: 0.9em; opacity: 0.8;">${details}</div>
                            </div>`;
                        
                        // ã€Œå±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€ã‚’æ¶ˆã™
                        if (resultLog.innerHTML.includes("å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“")) {
                            resultLog.innerHTML = "";
                        }
                        resultLog.innerHTML = newVoteLog + resultLog.innerHTML;
                        lastProcessedVoteKey = voteKey; // è¡¨ç¤ºã—ãŸã“ã¨ã‚’è¨˜éŒ²ï¼
                    }
                }
    
                // --- ğŸš© é å¾ãƒ­ã‚°ã®é‡è¤‡ã‚¬ãƒ¼ãƒ‰ ---
                if (data.lastMissionResult) {
                    // ã€Œãƒ©ã‚¦ãƒ³ãƒ‰ãƒ»æˆåŠŸå¤±æ•—ã€ã‚’çµ„ã¿åˆã‚ã›ãŸå°‚ç”¨ã®ã‚­ãƒ¼ã‚’ä½œã‚‹
                    const missionKey = `m_${data.lastMissionResult.round}_${data.lastMissionResult.success}`;
                    if (lastProcessedMissionKey !== missionKey) {
                        const mRes = data.lastMissionResult;
                        const color = mRes.success ? 'var(--blue)' : 'var(--red)';
                        const newMissionLog = `
                            <div style="border-left: 4px solid ${color}; padding-left: 10px; margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 8px;">
                                <strong style="color:${color}">ğŸš€ ç¬¬ ${mRes.round}R é å¾çµæœ: ${mRes.success ? 'æˆåŠŸ' : 'å¤±æ•—'}</strong><br>
                                <small>ãƒ¡ãƒ³ãƒãƒ¼: ${mRes.team}</small><br>
                                <div style="font-size: 0.9em; margin-top: 3px;">
                                    å¤±æ•—ã‚«ãƒ¼ãƒ‰: <b style="color:var(--red)">${mRes.fails} æš</b>
                                </div>
                            </div>`;
                        if (resultLog.innerHTML.includes("å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“")) resultLog.innerHTML = "";
                        resultLog.innerHTML = newMissionLog + resultLog.innerHTML;
                        const cards = [];
                            for(let i=0; i < (mRes.successes || 0); i++) cards.push(true);
                            for(let i=0; i < (mRes.fails || 0); i++) cards.push(false);
                            if (cards.length > 0) {
                                window.animateMissionResult(cards);
                            }
                        lastProcessedMissionKey = missionKey; // è¡¨ç¤ºã—ãŸã“ã¨ã‚’è¨˜éŒ²ï¼
                    }
                }
            }
// ğŸš© ã€ã“ã“ã¾ã§è¿½åŠ ã€‘
       if (!data.phase || data.phase === 'PROPOSING') {
           waitingMsg.innerHTML = `ç¬¬ ${roundNum} ãƒ©ã‚¦ãƒ³ãƒ‰ (å¿…è¦äººæ•°: <b>${required}å</b>)<br>ãƒªãƒ¼ãƒ€ãƒ¼: ${leaderName}${specialRuleMsg}`;
            // ğŸš© ãƒªãƒ¼ãƒ€ãƒ¼ãŒèª°ã‚’é¸ã‚“ã§ã„ã‚‹ã‹å…¨å“¡ã«è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
            // data.currentProposal ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹æƒ³å®šï¼ˆå¾Œè¿°ã®ä¿®æ­£ãŒå¿…è¦ï¼‰
            const currentSelected = data.currentProposal || [];
            const memberListHtml = all.map(p => {
                const isSelected = currentSelected.includes(String(p.id));
                const isPLeader = p.id == data.leaderIdx;
                return `
                    <div style="margin-bottom:5px;">
                        <label>
                            <input type="checkbox" class="team-check" value="${p.id}" 
                                ${isSelected ? 'checked' : ''} 
                                ${isLeader ? '' : 'disabled'}> 
                            ${isPLeader ? 'ğŸš©' : ''} ${p.name}
                        </label>
                    </div>`;
            }).join('');

            if (isLeader) {
                const isLastChance = failCount >= 4;
                actionArea.innerHTML = `
                    <h4 style="margin:0 0 10px 0;">${isLastChance ? 'ã€æœ€çµ‚ç¢ºèªã€‘' : ''}é å¾ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</h4>
                    <div style="text-align:left; background:rgba(255,255,255,0.05); padding:10px; border-radius:5px;">
                        ${memberListHtml}
                    </div>
                    <button class="btn" onclick="sendProposal(${isLastChance})">
                        ${isLastChance ? 'å¼·åˆ¶é å¾ã‚’é–‹å§‹ã™ã‚‹' : 'ææ¡ˆã‚’ç¢ºå®šã™ã‚‹'}
                    </button>
                `;
                // ğŸš© ãƒªãƒ¼ãƒ€ãƒ¼ãŒãƒã‚§ãƒƒã‚¯ã‚’å¤‰ãˆã‚‹ãŸã³ã«Firebaseã«ä¿å­˜ã™ã‚‹ä»•çµ„ã¿ã‚’è¿½åŠ ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸç”¨ï¼‰
                setTimeout(() => {
                    document.querySelectorAll('.team-check').forEach(el => {
                        el.onchange = () => {
                            const selected = Array.from(document.querySelectorAll('.team-check:checked')).map(cb => cb.value);
                            update(ref(db, `rooms/${roomId}`), { currentProposal: selected });
                        };
                    });
                }, 100);
            } else {
                actionArea.innerHTML = `
                    <p>${leaderName}ãŒãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸è€ƒä¸­...</p>
                    <div style="text-align:left; background:rgba(255,255,255,0.05); padding:10px; border-radius:5px; opacity:0.8;">
                        ${memberListHtml}
                    </div>
                    <p><small>(å¦æ±ºå›æ•°: ${failCount}/5)</small></p>
                `;
            }
        }
        else if (data.phase === 'VOTING') {
            const teamIds = data.currentProposal || [];
            const teamNames = teamIds.map(id => data.players[id].name).join(", ");
            waitingMsg.innerText = "ãƒãƒ¼ãƒ æ‰¿èªæŠ•ç¥¨ä¸­...";
            if (!data.votes || data.votes[myId] === undefined) {
                actionArea.innerHTML = `
                    <p>ææ¡ˆã•ã‚ŒãŸãƒãƒ¼ãƒ : <b style="color:var(--accent)">${teamNames}</b></p>
                    <div style="display:flex; gap:10px;">
                        <button class="btn" style="background:var(--blue)" onclick="castVote(true)">æ‰¿èª</button>
                        <button class="btn" style="background:var(--red)" onclick="castVote(false)">å´ä¸‹</button>
                    </div>
                `;
            } else {
                actionArea.innerHTML = "<p>ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŠ•ç¥¨ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>";
            }
        }
        else if (data.phase === 'MISSION') {
            const teamIds = data.currentProposal || [];
            const teamNames = teamIds.map(id => data.players[id] ? data.players[id].name : "ä¸æ˜").join(", ");
            const isMember = teamIds.includes(String(myId));
            const resultLog = document.getElementById('result-log');
            waitingMsg.innerHTML = `<span style="color:var(--accent)">é å¾ä¸­: ${teamNames}</span>`;
            if (isMember) {
                if (!data.missions || data.missions[myId] === undefined) {
                    actionArea.innerHTML = `
                        <div style="border:2px solid var(--accent); padding:10px; border-radius:10px;">
                            <p>ã“ã®é å¾ã‚’...</p>
                            <div style="display:flex; gap:10px;">
                                <button class="btn" style="background:var(--blue)" onclick="castMission(true)">æˆåŠŸã•ã›ã‚‹</button>
                                ${me.side === 'Evil' ? `<button class="btn" style="background:var(--red)" onclick="castMission(false)">å¤±æ•—ã•ã›ã‚‹</button>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    actionArea.innerHTML = "<p>å ±å‘Šå®Œäº†ã€‚å¾…æ©Ÿä¸­...</p>";
                }
            } else {
                actionArea.innerHTML = "<p>é å¾ãƒ¡ãƒ³ãƒãƒ¼ä»¥å¤–ã®äººã¯è­°è«–ã—ã¦å¾…ã£ã¦ã­ï¼</p>";
            }
        }
       // ğŸ‘ˆ ã“ã“ã«æ–°ã—ãè¿½åŠ ï¼
        else if (data.phase === 'ASSASSINATION') {
            const assassin = all.find(p => p.role === 'æš—æ®ºè€…');
            waitingMsg.innerHTML = `<span style="color:var(--red)">ğŸ¹ æš—æ®ºãƒ•ã‚§ãƒ¼ã‚º: æš—æ®ºè€…ãŒãƒãƒ¼ãƒªãƒ³ã‚’ç‹™ã£ã¦ã„ã¾ã™...</span>`;

            if (me.role === 'æš—æ®ºè€…') {
                const targets = all.filter(p => p.id != myId);
                const targetButtons = targets.map(p => 
                    `<button class="btn" style="background:#444; margin-bottom:5px;" onclick="executeAssassination(${p.id})">${p.name}ã‚’æš—æ®º</button>`
                ).join('');

                actionArea.innerHTML = `
                    <div style="border:2px solid var(--red); padding:15px; border-radius:10px;">
                        <p style="margin-top:0;">ãƒãƒ¼ãƒªãƒ³ã¯èª°ã ï¼Ÿæ­£è§£ã™ã‚Œã°é€†è»¢å‹åˆ©ï¼</p>
                        ${targetButtons}
                    </div>
                `;
            } else {
                actionArea.innerHTML = `<p>æš—æ®ºè€…ï¼ˆ${assassin ? assassin.name : 'ï¼Ÿ'}ï¼‰ã®æ±ºæ–­ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>`;
            }
        }
    }

    // ğŸš© ä¿®æ­£ï¼šææ¡ˆæ™‚ã«5äººç›®ã‹ã©ã†ã‹ã‚’åˆ¤æ–­
// ğŸš© window.sendProposal ã‚’ä¿®æ­£
   window.sendProposal = async (isForced) => {
    const selected = Array.from(document.querySelectorAll('.team-check:checked')).map(el => el.value);    
    // ğŸš© ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šFirebaseã‹ã‚‰æœ€æ–°ã®ã€ŒãƒŸãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã€ã‚’ç›´æ¥å–ã£ã¦ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’è¨ˆç®—ã™ã‚‹
    const snap = await get(ref(db, `rooms/${roomId}`));
    const data = snap.val();
    const history = data.missionHistory || [];
    const historyCount = history.length; // ã“ã‚Œã§ç¢ºå®Ÿã«ã€Œä»Šä½•ãƒ©ã‚¦ãƒ³ãƒ‰ç›®ã‹ã€ãŒã‚ã‹ã‚‹
    const allPlayers = Object.keys(data.players).length;
    const missionSizes = { 
        5:[2,3,2,3,3], 6:[2,3,4,3,4], 7:[2,3,3,4,4], 
        8:[3,4,4,5,5], 9:[3,4,4,5,5], 10:[3,4,4,5,5] 
    };
    const required = missionSizes[allPlayers] ? missionSizes[allPlayers][historyCount] : 0;
    if (selected.length !== required) {
        return alert(`äººæ•°ãŒé•ã„ã¾ã™ï¼ ${required} åé¸ã‚“ã§ãã ã•ã„ã€‚ï¼ˆç¾åœ¨ã¯ ${selected.length} åã§ã™ï¼‰`);
    }
    if (isForced) {
        if (!confirm("5äººç›®ã®ãƒªãƒ¼ãƒ€ãƒ¼ãªã®ã§æŠ•ç¥¨ãªã—ã§å¼·åˆ¶å‡ºç™ºã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        update(ref(db, `rooms/${roomId}`), {
            currentProposal: selected,
            phase: 'MISSION',
            missions: null,
            voteFailCount: 0
        });
    } else {
        update(ref(db, `rooms/${roomId}`), {
            currentProposal: selected,
            phase: 'VOTING',
            votes: null
        });
    }
};
    // --- ã“ã“ã‹ã‚‰ä¸‹ã¯æ–°ã—ã„é–¢æ•°ã¨ã—ã¦è¿½åŠ  ---
    window.castVote = (val) => {
        set(ref(db, `rooms/${roomId}/votes/${myId}`), val);
    };
    // ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®æˆåŠŸãƒ»å¤±æ•—ã‚’é€ä¿¡ã™ã‚‹
    window.castMission = (val) => {
        set(ref(db, `rooms/${roomId}/missions/${myId}`), val);
    };
        // ğŸš© scriptã‚¿ã‚°ã®æœ€å¾Œã®æ–¹ã€window.castMission ã®ä¸‹ã‚ãŸã‚Šã«è¿½åŠ 
    window.executeAssassination = async (targetId) => {
        const snap = await get(ref(db, `rooms/${roomId}`));
        const data = snap.val();
        const targetPlayer = data.players[targetId];
        
        if (!confirm(`${targetPlayer.name} ã‚’æš—æ®ºã—ã¾ã™ã‹ï¼Ÿ`)) return;

        // --- ğŸš© 1. æš—æ®ºæ¼”å‡ºï¼ˆã‚¿ãƒ¡ï¼‰ã®é–‹å§‹ ---
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: background 0.5s;
        `;
        overlay.innerHTML = `
            <div id="assassin-mark" style="font-size: 80px; filter: drop-shadow(0 0 20px red); margin-bottom: 20px;">ğŸ¹</div>
            <h1 id="assassin-text" style="color: #fff; font-family: serif; letter-spacing: 5px;">TARGET ACQUIRED...</h1>
        `;
        document.body.appendChild(overlay);

        // --- ğŸš© 2. æ•°ç§’å¾…æ©Ÿã—ã¦ç·Šå¼µæ„Ÿã‚’å‡ºã™ ---
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // ç”»é¢ã‚’èµ¤ãæŸ“ã‚ã‚‹ï¼
        overlay.style.background = "radial-gradient(circle, #800 0%, #000 100%)";
        document.getElementById('assassin-text').innerText = "EXECUTING...";
        document.getElementById('assassin-mark').style.transform = "scale(1.5)";
        document.getElementById('assassin-mark').style.transition = "transform 0.2s";

        await new Promise(resolve => setTimeout(resolve, 1500));

        // --- ğŸš© 3. åˆ¤å®šã¨Firebaseæ›´æ–° ---
        const isMerlin = targetPlayer.role === 'ãƒãƒ¼ãƒªãƒ³';
        const finalWinner = isMerlin ? 'Evil' : 'Good';
    
        await update(ref(db, `rooms/${roomId}`), {
            status: 'FINISHED',
            winner: finalWinner,
            phase: 'FINISHED',
            assassinationResult: {
                targetName: targetPlayer.name,
                isMerlin: isMerlin
            }
        });

        // æœ€å¾Œã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æ¶ˆã™
        setTimeout(() => overlay.remove(), 1000);
    };
    // ãƒ›ã‚¹ãƒˆç”¨ï¼šè‡ªå‹•ã§ãƒ•ã‚§ãƒ¼ã‚ºã‚’é€²ã‚ã‚‹ã‚¸ãƒ£ãƒƒã‚¸é–¢æ•°

    function handleAutoJudgment(data, pList) {

    if (data.phase === 'VOTING') {
        const votes = data.votes || {};
        if (Object.keys(votes).length === pList.length) {
            const approves = Object.values(votes).filter(v => v === true).length;
            const isApproved = approves > pList.length / 2;
            // æŠ•ç¥¨çµæœã®ãƒ­ã‚°ã‚’ä½œæˆ
           const voteLog = {
                round: data.missionHistory ? data.missionHistory.length + 1 : 1,
                turn: (data.voteFailCount || 0) + 1,
                leader: data.players[data.leaderIdx].name,
                team: data.currentProposal.map(id => data.players[id].name).join(", "),
                approved: isApproved,
                details: votes
            };

            setTimeout(() => {
                if (isApproved) {
                    update(ref(db, `rooms/${roomId}`), { 
                        phase: 'MISSION', 
                        missions: null,
                        voteFailCount: 0,
                        lastVoteResult: voteLog // ãƒ­ã‚°ã‚’ä¿å­˜
                    });
                } else {
                    update(ref(db, `rooms/${roomId}`), {
                        phase: 'PROPOSING',
                        leaderIdx: (data.leaderIdx + 1) % pList.length,
                        votes: null,
                        currentProposal: null,
                        voteFailCount: (data.voteFailCount || 0) + 1,
                        lastVoteResult: voteLog // ãƒ­ã‚°ã‚’ä¿å­˜
                    });
                }
            }, 1000);
        }
    }
        // 2. ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®é›†è¨ˆï¼ˆé å¾ãƒ¡ãƒ³ãƒãƒ¼ã®å ±å‘ŠãŒæƒã£ãŸã‚‰ï¼‰
        if (data.phase === 'MISSION') {
            const missions = data.missions || {};
            const memberCount = (data.currentProposal || []).length;
            if (Object.keys(missions).length === memberCount) {
                const fails = Object.values(missions).filter(v => v === false).length;
                const successes = Object.values(missions).filter(v => v === true).length;
                // ç¬¬4ãƒ©ã‚¦ãƒ³ãƒ‰ã‹ã¤7äººä»¥ä¸Šã®æ™‚ã ã‘ã€Œå¤±æ•—2æšä»¥ä¸Šã€ã§å¤±æ•—ã€ãã‚Œä»¥å¤–ã¯1æšä»¥ä¸Šã§å¤±æ•—
                const roundNum = (data.missionHistory || []).length + 1;
                const isSpecialRound = (pList.length >= 7 && roundNum === 4);
                const success = isSpecialRound ? (fails < 2) : (fails === 0);
                const currentHistory = data.missionHistory || [];
                currentHistory.push(success);

                const missionLog = {
                    round: currentHistory.length,
                    team: data.currentProposal.map(id => data.players[id].name).join(", "),
                    fails: fails,
                    successes: successes,
                    success: success
                };

                const wins = currentHistory.filter(v => v === true).length;
                const losses = currentHistory.filter(v => v === false).length;

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ™‚é–“ï¼ˆã‚«ãƒ¼ãƒ‰æšæ•° Ã— 1ç§’ + Î±ï¼‰ã‚’è€ƒæ…®ã—ã¦å°‘ã—é•·ã‚ã«å¾…ã¤
                const waitTime = 2000 + (memberCount * 1000) + 1000;

                setTimeout(() => {
                    if (wins === 3 || losses === 3) {
                        if (wins === 3) {
                            update(ref(db, `rooms/${roomId}`), {
                                phase: 'ASSASSINATION',
                                missionHistory: currentHistory,
                                lastMissionResult: missionLog
                            });
                        } else {
                            update(ref(db, `rooms/${roomId}`), {
                                status: 'FINISHED',
                                winner: 'Evil',
                                phase: 'FINISHED',
                                missionHistory: currentHistory,
                                lastMissionResult: missionLog
                            });
                        }
                    } else {
                        update(ref(db, `rooms/${roomId}`), {
                            phase: 'PROPOSING',
                            leaderIdx: (data.leaderIdx + 1) % pList.length,
                            missions: null,
                            votes: null,
                            currentProposal: null,
                            missionHistory: currentHistory,
                            lastMissionResult: missionLog
                        });
                    }
                }, waitTime); // ğŸš© ã“ã“ã§è‡ªå‹•ã§æ¬¡ã«é€²ã‚€ï¼
            }
        }
                
    }
    
     window.animateMissionResult = (results) => {
        if (document.getElementById('overlay-mission')) return;
        const overlay = document.createElement('div');
        overlay.id = 'overlay-mission';
        overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; display:flex; flex-direction:column; align-items:center; justify-content:center;";
        
        const shuffled = [...results].sort(() => Math.random() - 0.5);
        overlay.innerHTML = `
            <h2 id="mission-status-text" class="shaking" style="color:var(--accent); margin-bottom:20px;">çµæœã‚’å›åä¸­...</h2>
            <div id="card-container"></div>
        `;
        document.body.appendChild(overlay);
        const container = document.getElementById('card-container');
        const statusText = document.getElementById('mission-status-text');
    
        shuffled.forEach((res, i) => {
            const card = document.createElement('div');
            card.className = 'mission-card';
            card.innerHTML = `
                <div class="card-back">?</div>
                <div class="card-front ${res ? 'card-success' : 'card-fail'}">${res ? 'æˆåŠŸ' : 'å¤±æ•—'}</div>
            `;
            container.appendChild(card);
            setTimeout(() => {
                card.classList.add('reveal');
                if (!res) statusText.style.color = 'var(--red)';
            }, 1500 + (i * 1000));
        });
    
        setTimeout(() => {
            statusText.classList.remove('shaking');
            statusText.innerText = shuffled.filter(r => !r).length > 0 ? "é å¾å¤±æ•—..." : "é å¾æˆåŠŸï¼";
            setTimeout(() => {
                overlay.style.opacity = "0";
                overlay.style.transition = "opacity 0.8s";
                setTimeout(() => overlay.remove(), 800);
            }, 2000); 
            
        }, 1500 + (shuffled.length * 1000) + 500);
    };

    function createLogArea() {
        // ã™ã§ã«å­˜åœ¨ã—ã¦ãŸã‚‰ä½œã‚‰ãªã„
        if (document.getElementById('result-log')) return document.getElementById('result-log');

        const area = document.createElement('div');
        area.id = 'result-log';
        
        // --- è¦‹ãŸç›®ã®è¨­å®š ---
        area.style.cssText = `
            margin-top: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            font-size: 0.9em;
            clear: both;
        `;

        const parent = document.getElementById('game-screen');
        if (parent) {
            // insertBefore ã§ã¯ãªã appendChild ã«ã™ã‚‹ã“ã¨ã§
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã€Œä¸‹ã€ã«é…ç½®ã•ã‚Œã‚‹
            parent.appendChild(area); 
        }

        area.innerHTML = '<p style="color:#666; text-align:center;">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
        return area;
    }

    window.showRoleIntroduction = (roleName) => {
        const imageMap = {
            "ãƒãƒ¼ãƒªãƒ³": "merlin.jpg",
            "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«": "percival.jpg",
            "æ­£ç¾©ã®å¿ è‡£": "loyal.jpg",
            "æš—æ®ºè€…": "assassin.jpg",
            "ãƒ¢ãƒ«ã‚¬ãƒŠ": "morgana.jpg",
            "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰": "mordred.jpg",
            "ã‚ªãƒ™ãƒ­ãƒ³": "oberon.jpg",
            "é‚ªæ‚ªã®æ‰‹å…ˆ": "minion.jpg"
        };

        const overlay = document.createElement('div');
        overlay.id = "role-intro-overlay"; // IDã‚’ã¤ã‘ã¦ãŠã
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 20000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white;
            transition: opacity 1s;
        `;
        
        overlay.innerHTML = `<h2 id="intro-text" style="font-size: 1.5em; opacity: 0; transition: opacity 1s;">ã‚ãªãŸã¯...</h2>`;
        document.body.appendChild(overlay);

        setTimeout(() => {
            const el = document.getElementById('intro-text');
            if(el) el.style.opacity = "1";
        }, 500);

        setTimeout(() => {
            const imgFile = imageMap[roleName] || 'default.jpg';
            // ğŸš© GitHub Pagesã®å ´åˆã€ç›¸å¯¾ãƒ‘ã‚¹ã§ images/ãƒ•ã‚¡ã‚¤ãƒ«å ã§OK
            const imgPath = `images/${imgFile}`; 
            
            overlay.innerHTML = `
                <div style="text-align:center; animation: fadeIn 0.8s ease-out;">
                    <div style="font-size: 1em; margin-bottom: 10px; color: #aaa;">ã‚ãªãŸã®æ­£ä½“ã¯</div>
                    <h1 style="font-size: 3em; color: var(--accent); margin-bottom: 20px; text-shadow: 0 0 20px var(--accent);">${roleName}</h1>
                    <img src="${imgPath}" style="width: 250px; height: auto; border-radius: 15px; border: 2px solid #444;" 
                         onerror="this.src='https://via.placeholder.com/250x350?text=No+Image'">
                </div>
            `;
        }, 2500);

        setTimeout(() => {
            overlay.style.opacity = "0";
            setTimeout(() => overlay.remove(), 1000);
        }, 6500);
    };
// ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    window.toggleHelp = (rolesInGame = []) => {
        let modal = document.getElementById('help-modal');
        if (!modal) {
            // åˆå›ã ã‘ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
            modal = document.createElement('div');
            modal.id = 'help-modal';
            modal.onclick = () => modal.style.display = 'none'; // æ å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.body.appendChild(modal);
        }
    
        if (modal.style.display === 'block') {
            modal.style.display = 'none';
            return;
        }
    
        // å½¹è·ã®èª¬æ˜ãƒ‡ãƒ¼ã‚¿
        const descriptions = {
            "ãƒãƒ¼ãƒªãƒ³": "é‚ªæ‚ªãªãƒ¡ãƒ³ãƒãƒ¼ã‚’çŸ¥ã£ã¦ã„ã‚‹ã€‚æœ€å¾Œã«æš—æ®ºã•ã‚Œã‚‹ã¨è² ã‘ã€‚",
            "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«": "ãƒãƒ¼ãƒªãƒ³ï¼ˆã¨ãƒ¢ãƒ«ã‚¬ãƒŠï¼‰ãŒèª°ã‹è¦‹ãˆã¦ã„ã‚‹ã€‚",
            "æ­£ç¾©ã®å¿ è‡£": "èƒ½åŠ›ã¯ãªã„ã€‚é å¾ã‚’æˆåŠŸã•ã›ã‚‹ã®ãŒä½¿å‘½ã€‚",
            "æš—æ®ºè€…": "æœ€å¾Œã«ãƒãƒ¼ãƒªãƒ³ã‚’å½“ã¦ã‚Œã°é€†è»¢å‹åˆ©ã€‚",
            "ãƒ¢ãƒ«ã‚¬ãƒŠ": "ãƒ‘ãƒ¼ã‚·ãƒ´ã‚¡ãƒ«ã«å¯¾ã—ã¦ãƒãƒ¼ãƒªãƒ³ã®ãµã‚Šã‚’ã™ã‚‹ã€‚",
            "ãƒ¢ãƒ¼ãƒ‰ãƒ¬ãƒƒãƒ‰": "ãƒãƒ¼ãƒªãƒ³ã«æ­£ä½“ã‚’çŸ¥ã‚‰ã‚Œãªã„ã€‚",
            "ã‚ªãƒ™ãƒ­ãƒ³": "ä»²é–“ã‚’çŸ¥ã‚‰ãšã€ä»²é–“ã‹ã‚‰ã‚‚çŸ¥ã‚‰ã‚Œãªã„å­¤é«˜ã®é‚ªæ‚ªã€‚",
            "é‚ªæ‚ªã®æ‰‹å…ˆ": "èƒ½åŠ›ã¯ãªã„ã€‚é å¾ã‚’å¤±æ•—ã•ã›ã‚‹ã®ãŒä½¿å‘½ã€‚"
        };
    
        const roleListHtml = rolesInGame.map(r => `<li><strong>${r}</strong>: ${descriptions[r] || ''}</li>`).join('');
    
        modal.innerHTML = `
            <div class="help-content" onclick="event.stopPropagation()">
                <h2 style="color:var(--accent); margin-top:0;">ä»Šå›ã®å½¹è·æ§‹æˆ</h2>
                <ul style="text-align:left; font-size:0.9em; line-height:1.6;">
                    ${roleListHtml}
                </ul>
                <button onclick="document.getElementById('help-modal').style.display='none'" 
                        style="width:100%; padding:10px; margin-top:10px; background:#444; color:white; border:none; border-radius:5px;">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        `;
        modal.style.display = 'block';
    };

        
</script>
</body>
</html>
